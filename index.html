<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè´ Mountain View School - Complete Dynamic Management System</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: 'Segoe UI', Arial, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            transition: all 0.3s ease;
        }
        
        /* Dark Mode Styles */
        body.dark-mode {
            background: #1a1a1a;
        }
        
        body.dark-mode .main-header {
            background: linear-gradient(135deg, #1e1e1e 0%, #2d2d2d 100%);
            color: #ffffff;
        }
        
        body.dark-mode .nav-tabs {
            background: #2d2d2d;
            color: #ffffff;
        }
        
        body.dark-mode .nav-tab {
            color: #cccccc;
        }
        
        body.dark-mode .nav-tab:hover {
            background: #3d3d3d;
            color: #ffffff;
        }
        
        body.dark-mode .nav-tab.active {
            color: #ffffff;
            border-bottom: 3px solid #3498db;
            background: #3d3d3d;
        }
        
        body.dark-mode .control-panel {
            background: #2d2d2d;
            color: #ffffff;
        }
        
        body.dark-mode .paper {
            background: #2d2d2d;
            color: #ffffff;
        }
        
        body.dark-mode table th {
            background: linear-gradient(135deg, #1e1e1e 0%, #2d2d2d 100%);
            color: #ffffff;
        }
        
        body.dark-mode table td {
            color: #ffffff;
            border-color: #4a4a4a;
        }
        
        body.dark-mode .class-col {
            background: #3d3d3d;
            color: #ffffff;
        }
        
        body.dark-mode .modal-content {
            background: #2d2d2d;
            color: #ffffff;
        }
        
        body.dark-mode .form-group label {
            color: #ffffff;
        }
        
        body.dark-mode .form-group input,
        body.dark-mode .form-group select,
        body.dark-mode .form-group textarea {
            background: #3d3d3d;
            color: #ffffff;
            border-color: #4a4a4a;
        }
        
        body.dark-mode .form-group input::placeholder,
        body.dark-mode .form-group textarea::placeholder {
            color: #999999;
        }
        
        body.dark-mode .report-header h2,
        body.dark-mode .report-header .date {
            color: #ffffff;
        }
        
        body.dark-mode .stat-card {
            background: linear-gradient(135deg, #2d2d2d 0%, #3d3d3d 100%);
            color: #ffffff;
        }
        
        body.dark-mode .stat-number {
            color: #ffffff;
        }
        
        body.dark-mode .stat-label {
            color: #dddddd;
        }
        
        body.dark-mode .chart-container {
            background: #2d2d2d;
            color: #ffffff;
        }
        
        body.dark-mode .search-box {
            background: #3d3d3d;
            color: #ffffff;
            border-color: #4a4a4a;
        }
        
        body.dark-mode .search-box::placeholder {
            color: #999999;
        }
        
        body.dark-mode #reportOutput {
            color: #ffffff;
        }
        
        body.dark-mode #reportOutput table td {
            color: #ffffff;
        }
        
        body.dark-mode #reportOutput h3 {
            color: #ffffff;
        }
        
        body.dark-mode .offline-indicator {
            background: #2d2d2d;
            color: #ffffff;
            border: 1px solid #4a4a4a;
        }
        
        body.dark-mode .offline-indicator.online {
            background: #1e4a1e;
            color: #ffffff;
        }
        
        /* Login Overlay */
        #loginOverlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        
        .login-container {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            width: 400px;
            text-align: center;
        }
        
        .login-container h2 {
            color: #2c3e50;
            margin-bottom: 30px;
        }
        
        .login-container input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .login-container button {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
        }
        
        .login-container .forgot-password {
            margin-top: 15px;
            color: #3498db;
            cursor: pointer;
        }
        
        /* Main Container */
        .container {
            max-width: 1600px;
            margin: 0 auto;
            display: none;
        }
        
        /* Header */
        .main-header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 20px;
            border-radius: 15px 15px 0 0;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .main-header h1 { font-size: 32px; margin: 0; }
        .main-header p { font-size: 14px; opacity: 0.9; margin-top: 5px; }
        
        .admin-badge {
            background: #e74c3c;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            margin-left: 15px;
            display: inline-block;
        }
        
        /* Navigation */
        .nav-tabs {
            display: flex;
            background: white;
            border-radius: 0 0 15px 15px;
            overflow-x: auto;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .nav-tab {
            padding: 15px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
        }
        
        .nav-tab:hover { background: #f0f0f0; }
        .nav-tab.active { 
            border-bottom: 3px solid #3498db; 
            color: #3498db;
            background: #f8f9fa;
        }
        
        /* Control Panels */
        .control-panel {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .control-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
        }
        
        .btn:active {
            transform: scale(0.95);
        }
        
        .btn-primary { background: #3498db; color: white; }
        .btn-success { background: #27ae60; color: white; }
        .btn-warning { background: #f39c12; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-info { background: #00bcd4; color: white; }
        .btn-purple { background: #9b59b6; color: white; }
        .btn-secondary { background: #95a5a6; color: white; }
        
        .btn:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            filter: brightness(1.1);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .search-box {
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            width: 300px;
            font-size: 14px;
        }
        
        .search-box:focus { border-color: #3498db; outline: none; }
        
        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .stat-card:nth-child(2) { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .stat-card:nth-child(3) { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .stat-card:nth-child(4) { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        
        .stat-number { font-size: 32px; font-weight: bold; margin: 10px 0; }
        .stat-label { font-size: 14px; opacity: 0.9; }
        
        /* Paper/Report Section */
        .paper {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            overflow-x: auto;
        }
        
        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
            flex-wrap: wrap;
        }
        
        .report-header h2 { color: #2c3e50; margin: 0; }
        .report-header .date { color: #7f8c8d; font-style: italic; }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        
        th {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 12px;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        td {
            padding: 10px;
            border-bottom: 1px solid #ddd;
            text-align: center;
        }
        
        tr:hover { background: #f8f9fa; }
        
        .class-col { background: #f0f0f0; font-weight: bold; }
        
        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-content h3 { margin-bottom: 20px; color: #2c3e50; }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .form-group input:focus { border-color: #3498db; outline: none; }
        
        /* Timetable Grid */
        .timetable-grid {
            display: grid;
            grid-template-columns: 100px repeat(5, 1fr);
            gap: 5px;
            overflow-x: auto;
        }
        
        .timetable-header {
            background: #3498db;
            color: white;
            padding: 10px;
            text-align: center;
            font-weight: bold;
        }
        
        .timetable-cell {
            border: 1px solid #ddd;
            padding: 10px;
            min-height: 80px;
        }
        
        .timetable-time {
            background: #f0f0f0;
            font-weight: bold;
        }
        
        /* Class Management */
        .class-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
        }
        
        .class-item {
            background: #3498db;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }
        
        .class-item button {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-weight: bold;
        }
        
        /* Charts */
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
            display: block;
        }
        
        .chart-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        /* Report Output */
        #reportOutput {
            min-height: 200px;
        }
        
        #reportOutput table {
            margin-top: 20px;
        }
        
        #reportOutput h3 {
            margin-bottom: 15px;
            color: #2c3e50;
        }
        
        /* Offline indicator */
        .offline-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 30px;
            background: #e74c3c;
            color: white;
            display: none;
            font-size: 14px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        
        .offline-indicator.online { background: #27ae60; }
        
        /* Student search items */
        .student-search-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        
        .student-search-item:hover {
            background: #f5f5f5;
        }
        
        /* Parent section */
        .parent-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
        }
        
        .parent-card:hover {
            background: #e9ecef;
        }
        
        /* Grade colors - UPDATED to EE, ME, AE, BE */
        .grade-ee { color: #27ae60; font-weight: bold; }
        .grade-me { color: #2980b9; font-weight: bold; }
        .grade-ae { color: #f39c12; font-weight: bold; }
        .grade-be { color: #e67e22; font-weight: bold; }
        
        /* Print Styles */
        @media print {
            .control-panel, .nav-tabs, .stats-grid, .chart-container, 
            .offline-indicator, .btn, .modal, #loginOverlay {
                display: none !important;
            }
            
            .paper {
                box-shadow: none;
                padding: 0;
                margin: 0;
            }
            
            body {
                background: white;
                padding: 0;
            }
            
            table {
                page-break-inside: avoid;
            }
            
            th {
                background: #2c3e50 !important;
                color: white !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }
        
        /* Mobile responsive */
        @media (max-width: 768px) {
            .control-row { flex-direction: column; align-items: stretch; }
            .search-box { width: 100%; }
            .stats-grid { grid-template-columns: 1fr; }
            .chart-controls { flex-direction: column; }
            .nav-tabs { flex-wrap: wrap; }
            .nav-tab { flex: 1 1 auto; }
        }

        /* Trip Payments Container */
        .trip-payments-container {
            margin-top: 30px;
            border-top: 2px solid #3498db;
            padding-top: 20px;
        }

        .payment-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 5px;
        }

        .payment-item button {
            padding: 5px 10px;
        }
    </style>
</head>
<body>

<!-- Login Overlay -->
<div id="loginOverlay">
    <div class="login-container">
        <h2>üè´ Mountain View School</h2>
        <h3>Admin Login</h3>
        <input type="text" id="loginUsername" placeholder="Username" value="admin">
        <input type="password" id="loginPassword" placeholder="Password">
        <button onclick="login()">Login</button>
        <div class="forgot-password" onclick="showForgotPasswordModal()">Forgot Password?</div>
        <div class="forgot-password" onclick="showOTPRecoveryModal()">Recover with OTP</div>
    </div>
</div>

<!-- Forgot Password Modal -->
<div id="forgotPasswordModal" class="modal">
    <div class="modal-content">
        <h3>üîê Reset Password</h3>
        <div class="form-group">
            <label>Recovery Email</label>
            <input type="email" id="recoveryEmail" placeholder="Enter your recovery email">
        </div>
        <div class="form-group">
            <label>OTP Code</label>
            <input type="text" id="otpCode" placeholder="Enter OTP">
        </div>
        <div class="form-group">
            <label>New Password</label>
            <input type="password" id="newPassword" placeholder="Enter new password">
        </div>
        <div class="control-row">
            <button class="btn btn-primary" onclick="sendOTP()">Send OTP</button>
            <button class="btn btn-success" onclick="resetPassword()">Reset Password</button>
            <button class="btn btn-danger" onclick="closeModal('forgotPasswordModal')">Cancel</button>
        </div>
    </div>
</div>

<!-- OTP Recovery Modal -->
<div id="otpRecoveryModal" class="modal">
    <div class="modal-content">
        <h3>üì± OTP Recovery</h3>
        <div class="form-group">
            <label>Email Address</label>
            <input type="email" id="otpEmail" placeholder="Enter your email">
        </div>
        <div class="form-group">
            <label>OTP Code</label>
            <input type="text" id="otpCode2" placeholder="Enter OTP">
        </div>
        <div class="form-group">
            <label>New Password</label>
            <input type="password" id="newPassword2" placeholder="Enter new password">
        </div>
        <div class="control-row">
            <button class="btn btn-primary" onclick="sendOTP2()">Send OTP</button>
            <button class="btn btn-success" onclick="resetPasswordWithOTP()">Reset Password</button>
            <button class="btn btn-danger" onclick="closeModal('otpRecoveryModal')">Cancel</button>
        </div>
    </div>
</div>

<!-- Individual Student Report Modal -->
<div id="studentReportModal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
        <h3>üìÑ Individual Student Report</h3>
        <div id="studentReportContent"></div>
        <div class="control-row">
            <button class="btn btn-success" onclick="printStudentReport()">üñ®Ô∏è Print</button>
            <button class="btn btn-info" onclick="emailStudentReport()">üìß Email to Parent</button>
            <button class="btn btn-danger" onclick="closeModal('studentReportModal')">Close</button>
        </div>
    </div>
</div>

<!-- Individual Fee Tracking Modal -->
<div id="individualFeeModal" class="modal">
    <div class="modal-content">
        <h3>üí∞ Individual Fee Records</h3>
        <div class="form-group">
            <label>Search Student</label>
            <input type="text" id="individualFeeSearch" class="search-box" placeholder="Enter Name or Admission..." onkeyup="searchIndividualFeeStudent()">
        </div>
        <div id="individualFeeStudentList" style="max-height: 200px; overflow-y: auto;"></div>
        <div id="individualFeeDetails"></div>
        <div class="control-row">
            <button class="btn btn-danger" onclick="closeModal('individualFeeModal')">Close</button>
        </div>
    </div>
</div>

<!-- Delete Exam Result Modal -->
<div id="deleteExamResultModal" class="modal">
    <div class="modal-content">
        <h3>‚ö†Ô∏è Delete Exam Result</h3>
        <p>Are you sure you want to delete this exam result?</p>
        <p id="deleteResultInfo"></p>
        <input type="hidden" id="deleteResultId">
        <div class="control-row">
            <button class="btn btn-danger" onclick="confirmDeleteExamResult()">Delete</button>
            <button class="btn btn-secondary" onclick="closeModal('deleteExamResultModal')">Cancel</button>
        </div>
    </div>
</div>

<!-- Parent Email Modal -->
<div id="parentEmailModal" class="modal">
    <div class="modal-content">
        <h3>üìß Send Email to Parent</h3>
        <div class="form-group">
            <label>Parent Name</label>
            <input type="text" id="emailParentName" readonly>
        </div>
        <div class="form-group">
            <label>Parent Email</label>
            <input type="email" id="emailParentAddress" readonly>
        </div>
        <div class="form-group">
            <label>Select Child</label>
            <select id="emailChildSelect" class="search-box">
                <option value="">Select Child</option>
            </select>
        </div>
        <div class="form-group">
            <label>Subject</label>
            <input type="text" id="emailSubject" value="Student Progress Report">
        </div>
        <div class="form-group">
            <label>Message</label>
            <textarea id="emailMessage" rows="5" placeholder="Type your message..."></textarea>
        </div>
        <div class="control-row">
            <button class="btn btn-primary" onclick="attachReportToEmail()">üìé Attach Report</button>
            <button class="btn btn-success" onclick="sendParentEmail()">üìß Send Email</button>
            <button class="btn btn-danger" onclick="closeModal('parentEmailModal')">Cancel</button>
        </div>
    </div>
</div>

<!-- Add Class Modal -->
<div id="addClassModal" class="modal">
    <div class="modal-content">
        <h3>‚ûï Add New Class</h3>
        <div class="form-group">
            <label>Class Name (e.g., 9L, 8F, 7P)</label>
            <input type="text" id="newClassName" placeholder="Enter class name like 9L">
        </div>
        <div class="control-row">
            <button class="btn btn-success" onclick="addNewClass()">Add Class</button>
            <button class="btn btn-danger" onclick="closeModal('addClassModal')">Cancel</button>
        </div>
    </div>
</div>

<!-- Remove Class Modal -->
<div id="removeClassModal" class="modal">
    <div class="modal-content">
        <h3>üóëÔ∏è Remove Class</h3>
        <p class="warning" style="color: #e74c3c;">Warning: This will also remove all students in this class!</p>
        <div class="form-group">
            <label>Select Class</label>
            <select id="removeClassSelect" class="search-box">
                <option value="">Select Class</option>
            </select>
        </div>
        <div class="form-group">
            <label>Type "DELETE" to confirm</label>
            <input type="text" id="confirmDelete" placeholder="DELETE">
        </div>
        <div class="control-row">
            <button class="btn btn-danger" onclick="removeClass()">Remove Class</button>
            <button class="btn btn-secondary" onclick="closeModal('removeClassModal')">Cancel</button>
        </div>
    </div>
</div>

<!-- Clear All Roll Call Data Modal -->
<div id="clearAllRollCallModal" class="modal">
    <div class="modal-content">
        <h3>‚ö†Ô∏è Clear All Roll Call Data</h3>
        <p class="warning" style="color: #e74c3c;">Warning: This will clear ALL roll call data from the Google Sheet!</p>
        <p>This action cannot be undone. Only class names will remain.</p>
        <div class="form-group">
            <label>Type "CLEAR ALL" to confirm</label>
            <input type="text" id="confirmClearAll" placeholder="CLEAR ALL">
        </div>
        <div class="control-row">
            <button class="btn btn-danger" onclick="clearAllRollCallData()">Clear All Data</button>
            <button class="btn btn-secondary" onclick="closeModal('clearAllRollCallModal')">Cancel</button>
        </div>
    </div>
</div>

<!-- Trip Payment Modal -->
<div id="tripPaymentModal" class="modal">
    <div class="modal-content">
        <h3>üí∞ Record Trip Payment</h3>
        <div class="form-group">
            <label>Select Trip</label>
            <select id="paymentTripSelect" class="search-box">
                <option value="">Select Trip</option>
            </select>
        </div>
        <div class="form-group">
            <label>Search Student</label>
            <input type="text" id="paymentStudentSearch" class="search-box" placeholder="Enter student name..." onkeyup="searchPaymentStudent()">
        </div>
        <div id="paymentStudentList" style="max-height: 150px; overflow-y: auto; display: none;"></div>
        <div class="form-group">
            <label>Selected Student</label>
            <input type="text" id="paymentStudentName" readonly>
            <input type="hidden" id="paymentStudentAdmission">
        </div>
        <div class="form-group">
            <label>Amount Paid</label>
            <input type="number" id="paymentAmount" class="search-box" placeholder="Enter amount">
        </div>
        <div class="control-row">
            <button class="btn btn-success" onclick="recordTripPayment()">Record Payment</button>
            <button class="btn btn-danger" onclick="closeModal('tripPaymentModal')">Cancel</button>
        </div>
    </div>
</div>

<div class="offline-indicator" id="offlineIndicator">üü¢ Online</div>

<div class="container" id="mainContainer">
    <!-- Header -->
    <div class="main-header">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h1 id="schoolNameHeader">üè´ MOUNTAIN VIEW SCHOOL</h1>
            <div>
                <span class="admin-badge" id="adminBadge">Admin</span>
                <button class="btn btn-danger" onclick="logout()" style="margin-left: 15px;">Logout</button>
            </div>
        </div>
        <p>Complete Dynamic School Management System - No Dummy Data</p>
    </div>
    
    <!-- Navigation Tabs -->
    <div class="nav-tabs">
        <div class="nav-tab active" onclick="switchTab('rollcall')">üìã Roll Call</div>
        <div class="nav-tab" onclick="switchTab('students')">üë• Students</div>
        <div class="nav-tab" onclick="switchTab('teachers')">üë®‚Äçüè´ Teachers</div>
        <div class="nav-tab" onclick="switchTab('parents')">üë™ Parents</div>
        <div class="nav-tab" onclick="switchTab('classes')">üè´ Classes</div>
        <div class="nav-tab" onclick="switchTab('exams')">üìù Exams</div>
        <div class="nav-tab" onclick="switchTab('fees')">üí∞ Fees</div>
        <div class="nav-tab" onclick="switchTab('timetable')">‚è∞ Timetable</div>
        <div class="nav-tab" onclick="switchTab('trips')">üöå Trips</div>
        <div class="nav-tab" onclick="switchTab('analytics')">üìä Analytics</div>
        <div class="nav-tab" onclick="switchTab('reports')">üìà Reports</div>
        <div class="nav-tab" onclick="switchTab('settings')">‚öôÔ∏è Settings</div>
    </div>
    
    <!-- Tab Content: Roll Call -->
    <div id="tab-rollcall">
        <div class="control-panel">
            <div class="control-row">
                <input type="text" id="searchInput" class="search-box" placeholder="üîç Search Class..." onkeyup="filterTable()">
                <button class="btn btn-primary" onclick="loadData()" id="fetchBtn"><span>üîÑ</span> FETCH DAILY DATA</button>
                <button class="btn btn-success" onclick="printSection('rollcall-print')"><span>üñ®Ô∏è</span> PRINT REPORT</button>
                <button class="btn btn-info" onclick="downloadAsPDF('rollcall-print', 'Roll_Call_Report')"><span>üì•</span> DOWNLOAD PDF</button>
                <button class="btn btn-warning" onclick="clearCurrentRow()"><span>üóëÔ∏è</span> CLEAR CURRENT ROW</button>
                <button class="btn btn-danger" onclick="showClearAllModal()"><span>‚ö†Ô∏è</span> CLEAR ALL DATA</button>
                <button class="btn btn-purple" onclick="toggleDarkMode()"><span>üåì</span> DARK MODE</button>
            </div>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Total Students (Registered)</div>
                <div class="stat-number" id="statTotalReg">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Present Today</div>
                <div class="stat-number" id="statPresent">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Absent Today</div>
                <div class="stat-number" id="statAbsent">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Attendance %</div>
                <div class="stat-number" id="statPercent">0%</div>
            </div>
        </div>
        
        <div class="paper" id="rollcall-print">
            <div class="report-header">
                <h2>DAILY ROLL CALL CONSOLIDATED REPORT</h2>
                <div>
                    <span class="date" id="syncTime">Last Updated: Never</span><br>
                    <span class="date" id="currentDate"></span>
                </div>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th>CLASS</th>
                        <th>BOYS</th>
                        <th>GIRLS</th>
                        <th>TOTAL</th>
                        <th>LUNCH</th>
                        <th>NEW</th>
                        <th>N.R.</th>
                        <th>ABS#</th>
                        <th>ABSENTEE NAMES</th>
                        <th>ACTIONS</th>
                    </tr>
                </thead>
                <tbody id="rollTable"></tbody>
                <tfoot>
                    <tr style="background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); color: white; font-weight: bold;">
                        <td>TOTALS</td>
                        <td id="gBoys">0</td>
                        <td id="gGirls">0</td>
                        <td id="gTotal">0</td>
                        <td id="gLunch">0</td>
                        <td id="gNew">0</td>
                        <td id="gNR">0</td>
                        <td id="gAbs">0</td>
                        <td colspan="2">--</td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
    
    <!-- Tab Content: Students -->
    <div id="tab-students" style="display: none;">
        <div class="control-panel">
            <div class="control-row">
                <button class="btn btn-primary" onclick="showAddStudentModal()"><span>‚ûï</span> ADD STUDENT</button>
                <button class="btn btn-success" onclick="showBulkImportModal()"><span>üì§</span> BULK IMPORT</button>
                <button class="btn btn-info" onclick="exportStudents()"><span>üì•</span> EXPORT STUDENTS</button>
                <button class="btn btn-warning" onclick="printSection('students-print')"><span>üñ®Ô∏è</span> PRINT</button>
                <input type="text" id="searchStudents" class="search-box" placeholder="üîç Search by Name or Admission..." onkeyup="filterStudents()">
            </div>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Total Students</div>
                <div class="stat-number" id="studentCount">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Boys</div>
                <div class="stat-number" id="studentBoys">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Girls</div>
                <div class="stat-number" id="studentGirls">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">With Balances</div>
                <div class="stat-number" id="studentsWithBalance">0</div>
            </div>
        </div>
        
        <div class="paper" id="students-print">
            <div class="report-header">
                <h3>üë• Student Directory</h3>
                <span class="date">Click on a student to view detailed report</span>
            </div>
            
            <table id="studentsTable">
                <thead>
                    <tr>
                        <th>Admission No.</th>
                        <th>Name</th>
                        <th>Class</th>
                        <th>Gender</th>
                        <th>Route</th>
                        <th>Parent Name</th>
                        <th>Parent Phone</th>
                        <th>Email</th>
                        <th>Balance</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="studentsList"></tbody>
            </table>
        </div>
    </div>
    
    <!-- Tab Content: Teachers -->
    <div id="tab-teachers" style="display: none;">
        <div class="control-panel">
            <div class="control-row">
                <button class="btn btn-primary" onclick="showAddTeacherModal()"><span>‚ûï</span> ADD TEACHER</button>
                <button class="btn btn-info" onclick="exportTeachers()"><span>üì•</span> EXPORT TEACHERS</button>
                <button class="btn btn-warning" onclick="printSection('teachers-print')"><span>üñ®Ô∏è</span> PRINT</button>
                <input type="text" id="searchTeachers" class="search-box" placeholder="üîç Search Teachers..." onkeyup="filterTeachers()">
            </div>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Total Teachers</div>
                <div class="stat-number" id="teacherCount">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Male</div>
                <div class="stat-number" id="teacherMale">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Female</div>
                <div class="stat-number" id="teacherFemale">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">With Email</div>
                <div class="stat-number" id="teacherWithEmail">0</div>
            </div>
        </div>
        
        <div class="paper" id="teachers-print">
            <div class="report-header">
                <h3>üë®‚Äçüè´ Teachers Directory</h3>
                <span class="date">Total: <span id="teacherTotal">0</span> teachers</span>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th>TSC No.</th>
                        <th>Name</th>
                        <th>Gender</th>
                        <th>Subject</th>
                        <th>Phone</th>
                        <th>Email</th>
                        <th>Qualification</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="teachersList"></tbody>
            </table>
        </div>
    </div>
    
    <!-- Tab Content: Parents -->
    <div id="tab-parents" style="display: none;">
        <div class="control-panel">
            <div class="control-row">
                <input type="text" id="searchParents" class="search-box" placeholder="üîç Search Parent Name..." onkeyup="searchParents()">
                <button class="btn btn-success" onclick="exportParents()"><span>üì•</span> EXPORT PARENTS</button>
                <button class="btn btn-info" onclick="printSection('parents-print')"><span>üñ®Ô∏è</span> PRINT</button>
            </div>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Total Parents</div>
                <div class="stat-number" id="totalParents">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">With Email</div>
                <div class="stat-number" id="parentsWithEmail">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">With Phone</div>
                <div class="stat-number" id="parentsWithPhone">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Avg Children</div>
                <div class="stat-number" id="avgChildren">0</div>
            </div>
        </div>
        
        <div class="paper" id="parents-print">
            <div class="report-header">
                <h3>üë™ Parent Directory</h3>
                <span class="date">Search and manage parent communications</span>
            </div>
            
            <div id="parentSearchResults"></div>
            <div id="parentChildrenList" style="margin-top: 30px;"></div>
        </div>
    </div>
    
    <!-- Tab Content: Classes -->
    <div id="tab-classes" style="display: none;">
        <div class="control-panel">
            <div class="control-row">
                <button class="btn btn-primary" onclick="showAddClassModal()"><span>‚ûï</span> ADD CLASS</button>
                <button class="btn btn-danger" onclick="showRemoveClassModal()"><span>üóëÔ∏è</span> REMOVE CLASS</button>
                <button class="btn btn-info" onclick="refreshClassList()"><span>üîÑ</span> REFRESH</button>
            </div>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Total Classes</div>
                <div class="stat-number" id="totalClasses">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Students</div>
                <div class="stat-number" id="classTotalStudents">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Avg per Class</div>
                <div class="stat-number" id="avgPerClass">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Classes Active</div>
                <div class="stat-number" id="activeClasses">0</div>
            </div>
        </div>
        
        <div class="paper">
            <div class="report-header">
                <h3>üè´ Class Management</h3>
                <span class="date">Add or remove classes</span>
            </div>
            
            <div class="class-list" id="classList"></div>
            
            <h4 style="margin-top: 30px;">Class Details</h4>
            <table>
                <thead>
                    <tr>
                        <th>Class</th>
                        <th>Students</th>
                        <th>Boys</th>
                        <th>Girls</th>
                        <th>Class Teacher</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="classDetailsList"></tbody>
            </table>
        </div>
    </div>
    
    <!-- Tab Content: Exams -->
    <div id="tab-exams" style="display: none;">
        <div class="control-panel">
            <div class="control-row">
                <button class="btn btn-primary" onclick="showAddExamModal()"><span>‚ûï</span> ADD EXAM</button>
                <button class="btn btn-success" onclick="showAddExamResultModal()"><span>üìä</span> ADD RESULTS</button>
                <select id="examFilter" class="search-box" onchange="filterExams()">
                    <option value="">All Exams</option>
                </select>
                <button class="btn btn-info" onclick="exportExamResults()"><span>üì•</span> EXPORT RESULTS</button>
                <button class="btn btn-warning" onclick="printSection('exams-print')"><span>üñ®Ô∏è</span> PRINT</button>
            </div>
            <div class="control-row">
                <input type="text" id="searchExamStudent" class="search-box" placeholder="üîç Search Student for Report..." onkeyup="searchExamStudent()">
            </div>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Exams This Term</div>
                <div class="stat-number" id="examCount">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Average Score</div>
                <div class="stat-number" id="avgScore">0%</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Top Performer</div>
                <div class="stat-number" id="topPerformer">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Best Class</div>
                <div class="stat-number" id="bestExamClass">-</div>
            </div>
        </div>
        
        <div class="paper" id="exams-print">
            <div class="report-header">
                <h3>üìù Exam Records</h3>
                <span class="date">Term: <span id="currentTerm">1</span>, Year: <span id="currentYear">2026</span></span>
            </div>
            
            <div id="examStudentSearchResults" style="margin-bottom: 20px;"></div>
            
            <table>
                <thead>
                    <tr>
                        <th>Exam Name</th>
                        <th>Term</th>
                        <th>Year</th>
                        <th>Class</th>
                        <th>Subject</th>
                        <th>Students</th>
                        <th>Mean Score</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="examsList"></tbody>
            </table>
            
            <div style="margin-top: 30px;">
                <h4>üìä Detailed Results</h4>
                <table id="examResultsTable">
                    <thead>
                        <tr>
                            <th>Exam</th>
                            <th>Admission No.</th>
                            <th>Student Name</th>
                            <th>Class</th>
                            <th>Subject</th>
                            <th>Score</th>
                            <th>Grade</th>
                            <th>Position</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="examResultsList"></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Tab Content: Fees -->
    <div id="tab-fees" style="display: none;">
        <div class="control-panel">
            <div class="control-row">
                <button class="btn btn-primary" onclick="showRecordFeeModal()"><span>üí∞</span> RECORD FEE</button>
                <button class="btn btn-success" onclick="showFeeStructureModal()"><span>üìã</span> SET FEE STRUCTURE</button>
                <button class="btn btn-info" onclick="trackIndividualFee()"><span>üîç</span> TRACK INDIVIDUAL FEE</button>
                <button class="btn btn-warning" onclick="setTotalExpectedFee()"><span>üìä</span> SET TOTAL EXPECTED</button>
                <input type="text" id="searchFees" class="search-box" placeholder="üîç Search by Name or Admission..." onkeyup="filterFees()">
                <button class="btn btn-warning" onclick="printSection('fees-print')"><span>üñ®Ô∏è</span> PRINT</button>
            </div>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Total Fees Expected</div>
                <div class="stat-number" id="totalExpected">KSh 0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Paid</div>
                <div class="stat-number" id="totalPaid">KSh 0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Outstanding</div>
                <div class="stat-number" id="totalOutstanding">KSh 0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Collection Rate</div>
                <div class="stat-number" id="collectionRate">0%</div>
            </div>
        </div>
        
        <div class="paper" id="fees-print">
            <div class="report-header">
                <h3>üí∞ Fee Records</h3>
                <span class="date">Term: <span id="feeTerm">1</span>, Year: <span id="feeYear">2026</span></span>
            </div>
            
            <div id="feeStudentSearchResults" style="margin-bottom: 20px;"></div>
            
            <h4>Fee Structure Per Class</h4>
            <table>
                <thead>
                    <tr>
                        <th>Class</th>
                        <th>Term</th>
                        <th>Tuition</th>
                        <th>Transport</th>
                        <th>Boarding</th>
                        <th>Activities</th>
                        <th>Total</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="feeStructureList"></tbody>
            </table>
            
            <h4 style="margin-top: 30px;">Fee Payment Records</h4>
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Receipt No.</th>
                        <th>Admission No.</th>
                        <th>Student Name</th>
                        <th>Class</th>
                        <th>Term</th>
                        <th>Amount Paid</th>
                        <th>Balance</th>
                        <th>Payment Mode</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="feesList"></tbody>
            </table>
        </div>
    </div>
    
    <!-- Tab Content: Timetable -->
    <div id="tab-timetable" style="display: none;">
        <div class="control-panel">
            <div class="control-row">
                <select id="timetableClass" class="search-box" onchange="generateTimetable()">
                    <option value="">Select Class</option>
                </select>
                <button class="btn btn-primary" onclick="generateTimetable()"><span>üîÑ</span> GENERATE TIMETABLE</button>
                <button class="btn btn-success" onclick="showAddLessonModal()"><span>‚ûï</span> ADD LESSON</button>
                <button class="btn btn-warning" onclick="printSection('timetable-print')"><span>üñ®Ô∏è</span> PRINT</button>
                <button class="btn btn-info" onclick="validateTimetable()"><span>‚úì</span> VALIDATE</button>
            </div>
        </div>
        
        <div class="paper" id="timetable-print">
            <div class="report-header">
                <h3>‚è∞ Class Timetable</h3>
                <span class="date" id="timetableClassDisplay"></span>
            </div>
            
            <div id="timetableContainer" class="timetable-grid">
                <!-- Timetable will be generated here -->
            </div>
        </div>
    </div>
    
    <!-- Tab Content: Trips -->
    <div id="tab-trips" style="display: none;">
        <div class="control-panel">
            <div class="control-row">
                <button class="btn btn-primary" onclick="showAddTripModal()"><span>‚ûï</span> SCHEDULE TRIP</button>
                <button class="btn btn-success" onclick="showTripPaymentModal()"><span>üí∞</span> RECORD PAYMENT</button>
                <button class="btn btn-warning" onclick="printSection('trips-print')"><span>üñ®Ô∏è</span> PRINT</button>
                <input type="text" id="searchTrips" class="search-box" placeholder="üîç Search Trips..." onkeyup="filterTrips()">
            </div>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Total Trips</div>
                <div class="stat-number" id="totalTrips">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Upcoming</div>
                <div class="stat-number" id="upcomingTrips">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Past Trips</div>
                <div class="stat-number" id="pastTrips">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Students</div>
                <div class="stat-number" id="tripStudents">0</div>
            </div>
        </div>
        
        <div class="paper" id="trips-print">
            <div class="report-header">
                <h3>üöå Scheduled Trips</h3>
                <span class="date">Upcoming & Past Trips</span>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th>Destination</th>
                        <th>Date</th>
                        <th>Departure</th>
                        <th>Return</th>
                        <th>Classes</th>
                        <th>Teacher</th>
                        <th>Students</th>
                        <th>Cost</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="tripsList"></tbody>
            </table>
            
            <div id="tripPaymentsContainer" class="trip-payments-container">
                <!-- Trip payments will be displayed here -->
            </div>
        </div>
    </div>
    
    <!-- Tab Content: Analytics -->
    <div id="tab-analytics" style="display: none;">
        <div class="control-panel">
            <div class="chart-controls">
                <select id="analyticsType" class="search-box" onchange="updateAnalytics()">
                    <option value="attendance">Attendance Analytics</option>
                    <option value="students">Student Analytics</option>
                    <option value="teachers">Teacher Analytics</option>
                    <option value="exams">Exam Analytics</option>
                    <option value="fees">Fee Analytics</option>
                </select>
                <select id="analyticsPeriod" class="search-box">
                    <option value="weekly">Weekly</option>
                    <option value="monthly">Monthly</option>
                    <option value="termly">Termly</option>
                    <option value="yearly">Yearly</option>
                </select>
                <button class="btn btn-primary" onclick="updateAnalytics()">üìä Generate Analytics</button>
                <button class="btn btn-success" onclick="exportAnalytics()">üì• Export Data</button>
            </div>
        </div>
        
        <div class="stats-grid" id="analyticsStats">
            <!-- Stats will be populated dynamically -->
        </div>
        
        <div class="chart-container">
            <canvas id="analyticsChart"></canvas>
        </div>
    </div>
    
    <!-- Tab Content: Reports -->
    <div id="tab-reports" style="display: none;">
        <div class="control-panel">
            <div class="control-row">
                <select id="reportType" class="search-box">
                    <option value="rollcall">Roll Call Report</option>
                    <option value="students">Student Report</option>
                    <option value="teachers">Teacher Report</option>
                    <option value="exams">Exam Report</option>
                    <option value="fees">Fee Report</option>
                    <option value="trips">Trip Report</option>
                </select>
                <input type="date" id="reportStartDate" class="search-box">
                <input type="date" id="reportEndDate" class="search-box">
                <select id="reportClass" class="search-box">
                    <option value="all">All Classes</option>
                </select>
                <button class="btn btn-primary" onclick="generateReport()">üìÑ Generate Report</button>
                <button class="btn btn-success" onclick="downloadReportPDF()">üì• Download PDF</button>
                <button class="btn btn-warning" onclick="printSection('report-print')">üñ®Ô∏è Print</button>
            </div>
        </div>
        
        <div class="paper" id="report-print">
            <div id="reportOutput">
                <h3 style="text-align: center; padding: 40px;">üëà Select parameters and click Generate Report</h3>
            </div>
        </div>
    </div>
    
    <!-- Tab Content: Settings -->
    <div id="tab-settings" style="display: none;">
        <div class="control-panel">
            <h3 style="margin-bottom: 20px;">‚öôÔ∏è System Settings</h3>
            
            <div class="form-group">
                <label>School Name</label>
                <input type="text" id="schoolName" value="Mountain View School" class="search-box" style="width: 100%;">
            </div>
            
            <div class="form-group">
                <label>Current Term</label>
                <select id="currentTerm" class="search-box" style="width: 100%;">
                    <option value="1">Term 1</option>
                    <option value="2">Term 2</option>
                    <option value="3">Term 3</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Academic Year</label>
                <input type="text" id="academicYear" value="2026" class="search-box" style="width: 100%;">
            </div>
            
            <div class="form-group">
                <label>Recovery Email</label>
                <input type="email" id="recoveryEmailSettings" value="admin@mountainview.edu" class="search-box" style="width: 100%;">
            </div>
            
            <div class="form-group">
                <label>Change Password</label>
                <input type="password" id="currentPassword" placeholder="Current Password" class="search-box" style="width: 100%; margin-bottom: 10px;">
                <input type="password" id="newPasswordSettings" placeholder="New Password" class="search-box" style="width: 100%; margin-bottom: 10px;">
                <input type="password" id="confirmPassword" placeholder="Confirm New Password" class="search-box" style="width: 100%;">
                <small class="text-muted">Password will be updated immediately and used for future logins</small>
            </div>
            
            <div class="form-group">
                <label>Theme</label>
                <select id="themeSelect" class="search-box" style="width: 100%;" onchange="changeTheme()">
                    <option value="light">Light</option>
                    <option value="dark">Dark</option>
                </select>
            </div>
            
            <div class="control-row">
                <button class="btn btn-primary" onclick="saveSettings()">üíæ Save Settings</button>
                <button class="btn btn-warning" onclick="resetSettings()">üîÑ Reset to Default</button>
                <button class="btn btn-danger" onclick="updateSecuritySettings()">üîê Update Security</button>
                <button class="btn btn-info" onclick="backupData()">üíæ Backup Data</button>
                <button class="btn btn-success" onclick="restoreData()">üìÇ Restore Data</button>
            </div>
        </div>
    </div>
</div>

<!-- Student Modal -->
<div id="studentModal" class="modal">
    <div class="modal-content">
        <h3 id="modalTitle">‚ûï Add New Student</h3>
        <div class="form-group">
            <label>Admission Number *</label>
            <input type="text" id="studentAdmission" placeholder="e.g., STU2026001" required>
        </div>
        <div class="form-group">
            <label>Full Name *</label>
            <input type="text" id="studentName" placeholder="Enter student name" required>
        </div>
        <div class="form-group">
            <label>Class *</label>
            <select id="studentClass" required>
                <option value="">Select Class</option>
            </select>
        </div>
        <div class="form-group">
            <label>Gender</label>
            <select id="studentGender">
                <option value="Boy">Boy</option>
                <option value="Girl">Girl</option>
            </select>
        </div>
        <div class="form-group">
            <label>Transport Route (if non-boarder)</label>
            <input type="text" id="studentRoute" placeholder="e.g., Route A, B, C or Boarder">
        </div>
        <div class="form-group">
            <label>Parent Name</label>
            <input type="text" id="parentName" placeholder="Enter parent name">
        </div>
        <div class="form-group">
            <label>Parent Phone</label>
            <input type="text" id="parentPhone" placeholder="Enter parent phone">
        </div>
        <div class="form-group">
            <label>Parent Email</label>
            <input type="email" id="parentEmail" placeholder="Enter parent email">
        </div>
        <div class="control-row" style="justify-content: flex-end;">
            <button class="btn btn-danger" onclick="closeModal('studentModal')">Cancel</button>
            <button class="btn btn-success" onclick="saveStudent()">Save Student</button>
        </div>
    </div>
</div>

<!-- Teacher Modal (UPDATED with Gender) -->
<div id="teacherModal" class="modal">
    <div class="modal-content">
        <h3>‚ûï Add New Teacher</h3>
        <div class="form-group">
            <label>TSC Number *</label>
            <input type="text" id="teacherTSC" placeholder="e.g., TSC2026001" required>
        </div>
        <div class="form-group">
            <label>Full Name *</label>
            <input type="text" id="teacherName" placeholder="Enter teacher name" required>
        </div>
        <div class="form-group">
            <label>Gender *</label>
            <select id="teacherGender" required>
                <option value="">Select Gender</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
            </select>
        </div>
        <div class="form-group">
            <label>Subject Specialization</label>
            <input type="text" id="teacherSubject" placeholder="e.g., Mathematics">
        </div>
        <div class="form-group">
            <label>Phone</label>
            <input type="text" id="teacherPhone" placeholder="Enter phone number">
        </div>
        <div class="form-group">
            <label>Email</label>
            <input type="email" id="teacherEmail" placeholder="Enter email">
        </div>
        <div class="form-group">
            <label>Qualification</label>
            <input type="text" id="teacherQualification" placeholder="e.g., B.Ed, Masters">
        </div>
        <div class="control-row" style="justify-content: flex-end;">
            <button class="btn btn-danger" onclick="closeModal('teacherModal')">Cancel</button>
            <button class="btn btn-success" onclick="saveTeacher()">Save Teacher</button>
        </div>
    </div>
</div>

<!-- Lesson Modal (UPDATED with dynamic time) -->
<div id="lessonModal" class="modal">
    <div class="modal-content">
        <h3>‚ûï Add Lesson</h3>
        <div class="form-group">
            <label>Teacher *</label>
            <select id="lessonTeacher" required>
                <option value="">Select Teacher</option>
            </select>
        </div>
        <div class="form-group">
            <label>Class *</label>
            <select id="lessonClass" required>
                <option value="">Select Class</option>
            </select>
        </div>
        <div class="form-group">
            <label>Subject *</label>
            <input type="text" id="lessonSubject" placeholder="e.g., Mathematics" required>
        </div>
        <div class="form-group">
            <label>Day</label>
            <select id="lessonDay">
                <option value="Monday">Monday</option>
                <option value="Tuesday">Tuesday</option>
                <option value="Wednesday">Wednesday</option>
                <option value="Thursday">Thursday</option>
                <option value="Friday">Friday</option>
            </select>
        </div>
        <div class="form-group">
            <label>Start Time</label>
            <input type="time" id="lessonStartTime" value="08:00">
        </div>
        <div class="form-group">
            <label>End Time</label>
            <input type="time" id="lessonEndTime" value="08:40">
        </div>
        <div class="control-row" style="justify-content: flex-end;">
            <button class="btn btn-danger" onclick="closeModal('lessonModal')">Cancel</button>
            <button class="btn btn-success" onclick="saveLesson()">Save Lesson</button>
        </div>
    </div>
</div>

<!-- Exam Modal -->
<div id="examModal" class="modal">
    <div class="modal-content">
        <h3>‚ûï Add Exam</h3>
        <div class="form-group">
            <label>Exam Name *</label>
            <input type="text" id="examName" placeholder="e.g., End Term 1 Exam" required>
        </div>
        <div class="form-group">
            <label>Term</label>
            <select id="examTerm">
                <option value="1">Term 1</option>
                <option value="2">Term 2</option>
                <option value="3">Term 3</option>
            </select>
        </div>
        <div class="form-group">
            <label>Year</label>
            <input type="text" id="examYear" value="2026">
        </div>
        <div class="form-group">
            <label>Start Date</label>
            <input type="date" id="examStartDate">
        </div>
        <div class="form-group">
            <label>End Date</label>
            <input type="date" id="examEndDate">
        </div>
        <div class="control-row" style="justify-content: flex-end;">
            <button class="btn btn-danger" onclick="closeModal('examModal')">Cancel</button>
            <button class="btn btn-success" onclick="saveExam()">Save Exam</button>
        </div>
    </div>
</div>

<!-- Exam Result Modal -->
<div id="examResultModal" class="modal">
    <div class="modal-content">
        <h3>üìä Add Exam Results</h3>
        <div class="form-group">
            <label>Select Exam</label>
            <select id="resultExam" onchange="loadExamStudents()">
                <option value="">Select Exam</option>
            </select>
        </div>
        <div class="form-group">
            <label>Class</label>
            <select id="resultClass" onchange="loadExamStudents()">
                <option value="">Select Class</option>
            </select>
        </div>
        <div class="form-group">
            <label>Subject</label>
            <input type="text" id="resultSubject" placeholder="Subject">
        </div>
        <div id="studentResultsContainer">
            <!-- Student results will be loaded here dynamically -->
        </div>
        <div class="control-row" style="justify-content: flex-end;">
            <button class="btn btn-danger" onclick="closeModal('examResultModal')">Cancel</button>
            <button class="btn btn-success" onclick="saveExamResults()">Save Results</button>
        </div>
    </div>
</div>

<!-- Fee Modal -->
<div id="feeModal" class="modal">
    <div class="modal-content">
        <h3>üí∞ Record Fee Payment</h3>
        <div class="form-group">
            <label>Search Student *</label>
            <input type="text" id="feeSearchStudent" placeholder="Enter Name or Admission No." onkeyup="searchFeeStudent()">
        </div>
        <div id="feeStudentList" style="max-height: 150px; overflow-y: auto; border: 1px solid #ddd; margin-bottom: 15px; display: none;">
            <!-- Student search results -->
        </div>
        <div class="form-group">
            <label>Admission Number *</label>
            <input type="text" id="feeAdmission" readonly>
        </div>
        <div class="form-group">
            <label>Student Name *</label>
            <input type="text" id="feeStudentName" readonly>
        </div>
        <div class="form-group">
            <label>Class *</label>
            <input type="text" id="feeClass" readonly>
        </div>
        <div class="form-group">
            <label>Term</label>
            <select id="feeTermSelect">
                <option value="1">Term 1</option>
                <option value="2">Term 2</option>
                <option value="3">Term 3</option>
            </select>
        </div>
        <div class="form-group">
            <label>Amount Paid *</label>
            <input type="number" id="feeAmount" placeholder="Enter amount" min="0" step="100" required>
        </div>
        <div class="form-group">
            <label>Payment Mode</label>
            <select id="feeMode">
                <option value="Cash">Cash</option>
                <option value="M-Pesa">M-Pesa</option>
                <option value="Bank">Bank</option>
                <option value="Cheque">Cheque</option>
            </select>
        </div>
        <div class="form-group">
            <label>Receipt Number</label>
            <input type="text" id="feeReceipt" placeholder="Auto-generated" readonly>
        </div>
        <div class="control-row" style="justify-content: flex-end;">
            <button class="btn btn-danger" onclick="closeModal('feeModal')">Cancel</button>
            <button class="btn btn-success" onclick="recordFeePayment()">Record Payment</button>
        </div>
    </div>
</div>

<!-- Fee Structure Modal (UPDATED) -->
<div id="feeStructureModal" class="modal">
    <div class="modal-content">
        <h3>üìã Fee Structure</h3>
        <div class="form-group">
            <label>Class</label>
            <select id="feeStructureClass">
                <option value="">Select Class</option>
            </select>
        </div>
        <div class="form-group">
            <label>Term</label>
            <select id="feeStructureTerm">
                <option value="1">Term 1</option>
                <option value="2">Term 2</option>
                <option value="3">Term 3</option>
            </select>
        </div>
        <div class="form-group">
            <label>Tuition Fee</label>
            <input type="number" id="feeTuition" value="0" min="0">
        </div>
        <div class="form-group">
            <label>Transport Fee (if applicable)</label>
            <input type="number" id="feeTransport" value="0" min="0">
        </div>
        <div class="form-group">
            <label>Boarding Fee</label>
            <input type="number" id="feeBoarding" value="0" min="0">
        </div>
        <div class="form-group">
            <label>Activities Fee</label>
            <input type="number" id="feeActivities" value="0" min="0">
        </div>
        <div class="form-group">
            <label>Total Expected Fee per Student</label>
            <input type="number" id="feeTotal" readonly class="search-box" style="background: #e8f4fd; font-weight: bold;">
        </div>
        <div class="control-row" style="justify-content: flex-end;">
            <button class="btn btn-danger" onclick="closeModal('feeStructureModal')">Cancel</button>
            <button class="btn btn-success" onclick="saveFeeStructure()">Save Structure</button>
        </div>
    </div>
</div>

<!-- Total Expected Fee Modal (NEW) -->
<div id="totalExpectedFeeModal" class="modal">
    <div class="modal-content">
        <h3>üìä Set Total Expected Fee</h3>
        <p class="info" style="background: #e8f4fd; padding: 10px; border-radius: 8px; margin-bottom: 20px;">
            This will set the total expected fee for ALL students in the selected class for the current term.
        </p>
        <div class="form-group">
            <label>Select Class</label>
            <select id="totalFeeClass" class="search-box">
                <option value="">Select Class</option>
            </select>
        </div>
        <div class="form-group">
            <label>Total Expected Fee per Student (KSh)</label>
            <input type="number" id="totalFeeAmount" class="search-box" placeholder="Enter amount" min="0">
        </div>
        <div class="form-group">
            <label>Term</label>
            <select id="totalFeeTerm" class="search-box">
                <option value="1">Term 1</option>
                <option value="2">Term 2</option>
                <option value="3">Term 3</option>
            </select>
        </div>
        <div class="control-row">
            <button class="btn btn-success" onclick="saveTotalExpectedFee()">Set Expected Fee</button>
            <button class="btn btn-danger" onclick="closeModal('totalExpectedFeeModal')">Cancel</button>
        </div>
    </div>
</div>

<!-- Trip Modal -->
<div id="tripModal" class="modal">
    <div class="modal-content">
        <h3>üöå Schedule Trip</h3>
        <div class="form-group">
            <label>Destination *</label>
            <input type="text" id="tripDestination" placeholder="e.g., National Museum" required>
        </div>
        <div class="form-group">
            <label>Date *</label>
            <input type="date" id="tripDate" required>
        </div>
        <div class="form-group">
            <label>Departure Time</label>
            <input type="time" id="tripDeparture" value="08:00">
        </div>
        <div class="form-group">
            <label>Return Time</label>
            <input type="time" id="tripReturn" value="16:00">
        </div>
        <div class="form-group">
            <label>Classes</label>
            <select id="tripClasses" multiple size="3">
                <!-- Classes will be populated -->
            </select>
            <small>Hold Ctrl to select multiple</small>
        </div>
        <div class="form-group">
            <label>Teacher in Charge</label>
            <select id="tripTeacher">
                <option value="">Select Teacher</option>
            </select>
        </div>
        <div class="form-group">
            <label>Cost per Student</label>
            <input type="number" id="tripCost" value="0" min="0">
        </div>
        <div class="form-group">
            <label>Notes</label>
            <textarea id="tripNotes" rows="3" placeholder="Additional information..."></textarea>
        </div>
        <div class="control-row" style="justify-content: flex-end;">
            <button class="btn btn-danger" onclick="closeModal('tripModal')">Cancel</button>
            <button class="btn btn-success" onclick="saveTrip()">Schedule Trip</button>
        </div>
    </div>
</div>

<!-- Bulk Import Modal -->
<div id="importModal" class="modal">
    <div class="modal-content">
        <h3>üì§ Bulk Import Students</h3>
        <p>Paste CSV data in format: Admission,Name,Class,Gender,Route,ParentName,ParentPhone,ParentEmail</p>
        <div class="form-group">
            <textarea id="importData" rows="10" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;"></textarea>
        </div>
        <div class="control-row" style="justify-content: flex-end;">
            <button class="btn btn-danger" onclick="closeModal('importModal')">Cancel</button>
            <button class="btn btn-success" onclick="importStudents()">Import</button>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
<script>
    // Initialize EmailJS with provided keys (hidden from UI)
    (function() {
        // These are now hardcoded and hidden from the interface
        const EMAILJS_PUBLIC_KEY = "mc8vKTjCZkXqh_ll5";
        const EMAILJS_SERVICE_ID = "service_126zasj";
        const EMAILJS_TEMPLATE_ID = "template_054xe2o";
        
        emailjs.init(EMAILJS_PUBLIC_KEY);
        
        // Store for internal use
        window.emailJSConfig = {
            publicKey: EMAILJS_PUBLIC_KEY,
            serviceId: EMAILJS_SERVICE_ID,
            templateId: EMAILJS_TEMPLATE_ID,
            fromName: 'Mountain View School'
        };
    })();
    
    // ========== EMAILJS FUNCTIONS ==========
    async function sendEmailJS(to, subject, message, htmlContent = null) {
        try {
            const templateParams = {
                to_email: to,
                to_name: to.split('@')[0],
                from_name: window.emailJSConfig.fromName,
                from_email: 'noreply@mountainview.edu',
                subject: subject,
                message: message,
                html_message: htmlContent || message,
                school_name: settings.schoolName,
                reply_to: 'noreply@mountainview.edu'
            };
            
            const response = await emailjs.send(
                window.emailJSConfig.serviceId,
                window.emailJSConfig.templateId,
                templateParams
            );
            
            return response.status === 200;
        } catch (error) {
            console.error('EmailJS error:', error);
            alert('‚ùå Error sending email: ' + (error.text || 'Unknown error'));
            return false;
        }
    }
    
    // ========== SECURITY & AUTHENTICATION ==========
    let isAuthenticated = false;
    let ADMIN_PASSWORD = localStorage.getItem('adminPassword') || "admin123";
    let ADMIN_USERNAME = "admin";
    let recoveryEmail = localStorage.getItem('recoveryEmail') || "admin@mountainview.edu";
    let otpStore = null;
    
    // Check if already logged in from session
    if (sessionStorage.getItem('authenticated') === 'true') {
        isAuthenticated = true;
        document.getElementById('loginOverlay').style.display = 'none';
        document.getElementById('mainContainer').style.display = 'block';
    }
    
    function login() {
        const username = document.getElementById('loginUsername').value;
        const password = document.getElementById('loginPassword').value;
        
        if (username === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
            isAuthenticated = true;
            sessionStorage.setItem('authenticated', 'true');
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('mainContainer').style.display = 'block';
            initializeSystem();
            showNotification('‚úÖ Login successful!');
        } else {
            alert('‚ùå Invalid credentials!');
        }
    }
    
    function logout() {
        if (confirm('Are you sure you want to logout?')) {
            isAuthenticated = false;
            sessionStorage.removeItem('authenticated');
            document.getElementById('loginOverlay').style.display = 'flex';
            document.getElementById('mainContainer').style.display = 'none';
        }
    }
    
    function showForgotPasswordModal() {
        document.getElementById('forgotPasswordModal').style.display = 'flex';
    }
    
    function showOTPRecoveryModal() {
        document.getElementById('otpRecoveryModal').style.display = 'flex';
    }
    
    async function sendOTP() {
        const email = document.getElementById('recoveryEmail').value;
        if (email === recoveryEmail) {
            otpStore = Math.floor(100000 + Math.random() * 900000).toString();
            
            const subject = 'Password Reset OTP - Mountain View School';
            const message = `Your OTP for password reset is: ${otpStore}\n\nThis code will expire in 10 minutes.\n\nIf you did not request this, please ignore this email.`;
            
            const sent = await sendEmailJS(email, subject, message);
            
            if (sent) {
                alert(`‚úÖ OTP sent to ${email}`);
                showNotification('‚úÖ OTP sent! Check your email.');
            } else {
                alert('‚ùå Failed to send OTP. Please check EmailJS configuration.');
            }
        } else {
            alert('‚ùå Email not found!');
        }
    }
    
    async function sendOTP2() {
        const email = document.getElementById('otpEmail').value;
        if (email === recoveryEmail) {
            otpStore = Math.floor(100000 + Math.random() * 900000).toString();
            
            const subject = 'Password Reset OTP - Mountain View School';
            const message = `Your OTP for password reset is: ${otpStore}\n\nThis code will expire in 10 minutes.\n\nIf you did not request this, please ignore this email.`;
            
            const sent = await sendEmailJS(email, subject, message);
            
            if (sent) {
                alert(`‚úÖ OTP sent to ${email}`);
                showNotification('‚úÖ OTP sent! Check your email.');
            } else {
                alert('‚ùå Failed to send OTP. Please check EmailJS configuration.');
            }
        } else {
            alert('‚ùå Email not found!');
        }
    }
    
    function resetPassword() {
        const otp = document.getElementById('otpCode').value;
        const newPass = document.getElementById('newPassword').value;
        
        if (otp === otpStore) {
            ADMIN_PASSWORD = newPass;
            localStorage.setItem('adminPassword', newPass);
            alert('‚úÖ Password reset successful!');
            closeModal('forgotPasswordModal');
            showNotification('Password updated!');
        } else {
            alert('‚ùå Invalid OTP!');
        }
    }
    
    function resetPasswordWithOTP() {
        const otp = document.getElementById('otpCode2').value;
        const newPass = document.getElementById('newPassword2').value;
        
        if (otp === otpStore) {
            ADMIN_PASSWORD = newPass;
            localStorage.setItem('adminPassword', newPass);
            alert('‚úÖ Password reset successful!');
            closeModal('otpRecoveryModal');
            showNotification('Password updated!');
        } else {
            alert('‚ùå Invalid OTP!');
        }
    }
    
    // ========== CONFIGURATION ==========
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzt-Fk8eAIxH3CUkRKEUFhccYSojbVNo9KiwkxxI2UPrN74W14cd-G8pyhdtMGIx4et/exec'; 
    
    // ORIGINAL CLASS NAMES - PRESERVED EXACTLY AS REQUESTED
    const classList = [
        "9L", "9F", "9U", "9J", "9G", "8L", "8F", "8U", "8G", "8P",
        "7P", "7L", "7F", "7U", "7G", "6P", "6J", "6L", "6F", "6U",
        "5P", "5J", "5L", "5F", "5U", "4P", "4J", "4L", "4F", "4G", "4U",
        "3L", "3P", "3J", "3U", "2P", "2J", "2L", "2F", "2U",
        "1P", "1L", "1J", "1U", "1F",
        "P.P.2 PEACE", "P.P.2 JOY", "P.P.2 LOVE", "P.P.2 FAITH",
        "P.P.1 PEACE", "P.P.1 FAITH", "P.P.1 LOVE", "P.P.1 JOY", "P.P.1 GLORY",
        "F.C. PEACE", "F.C. LOVE", "F.C. JOY", "9P"
    ];
    
    const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"];
    const timeSlots = ["08:00-08:40", "08:40-09:20", "09:20-10:00", "10:00-10:40", "11:00-11:40", "11:40-12:20", "12:20-13:00", "14:00-14:40", "14:40-15:20", "15:20-16:00"];
    
    // ========== GLOBAL VARIABLES ==========
    let students = JSON.parse(localStorage.getItem('students')) || [];
    let teachers = JSON.parse(localStorage.getItem('teachers')) || [];
    let lessons = JSON.parse(localStorage.getItem('lessons')) || [];
    let exams = JSON.parse(localStorage.getItem('exams')) || [];
    let examResults = JSON.parse(localStorage.getItem('examResults')) || [];
    let fees = JSON.parse(localStorage.getItem('fees')) || [];
    let feeStructure = JSON.parse(localStorage.getItem('feeStructure')) || {};
    let trips = JSON.parse(localStorage.getItem('trips')) || [];
    let tripPayments = JSON.parse(localStorage.getItem('tripPayments')) || [];
    let attendanceHistory = JSON.parse(localStorage.getItem('attendanceHistory')) || [];
    let classes = JSON.parse(localStorage.getItem('classes')) || [];
    let activities = JSON.parse(localStorage.getItem('activities')) || [];
    
    let settings = JSON.parse(localStorage.getItem('settings')) || {
        schoolName: 'Mountain View School',
        currentTerm: '1',
        academicYear: '2026',
        theme: 'light'
    };
    
    let chart = null;
    let editingIndex = -1;
    
    // Initialize classes from the original classList if not already saved
    if (classes.length === 0) {
        classes = classList.map(cls => ({ name: cls, streams: ["A"] }));
        localStorage.setItem('classes', JSON.stringify(classes));
    }
    
    // ========== INITIALIZATION ==========
    function initializeSystem() {
        updateDate();
        buildTable();
        loadClassSelectors();
        loadStudents();
        loadTeachers();
        loadExams();
        loadFees();
        loadTrips();
        loadLessons();
        loadClasses();
        loadFeeStructureList();
        applySettings();
        checkOnlineStatus();
        updateStatistics();
        updateFeeStats();
        updateExamStats();
        loadClassDropdowns();
        generateReceiptNumber();
        logActivity('System initialized');
    }
    
    function updateDate() {
        const dateElement = document.getElementById('currentDate');
        if (dateElement) {
            dateElement.innerText = new Date().toLocaleDateString('en-GB', { 
                day: '2-digit', month: 'long', year: 'numeric' 
            });
        }
    }
    
    function logActivity(action) {
        activities.unshift({
            time: new Date().toISOString(),
            action: action,
            user: 'Admin'
        });
        if (activities.length > 100) activities = activities.slice(0, 100);
        localStorage.setItem('activities', JSON.stringify(activities));
    }
    
    function buildTable() {
        const tbody = document.getElementById('rollTable');
        if (!tbody) return;
        
        tbody.innerHTML = "";
        classList.forEach(cls => {
            const tr = document.createElement('tr');
            tr.setAttribute('data-class', cls);
            tr.innerHTML = `
                <td class="class-col">${cls}</td>
                <td class="c-b">0</td>
                <td class="c-g">0</td>
                <td class="c-t">0</td>
                <td class="c-l">0</td>
                <td class="c-n">0</td>
                <td class="c-nr">0</td>
                <td class="c-a">0</td>
                <td class="absent-names c-names">-</td>
                <td>
                    <button class="btn btn-primary" style="padding: 5px;" onclick="viewClassDetails('${cls}')">üëÅÔ∏è</button>
                    <button class="btn btn-warning" style="padding: 5px;" onclick="editClass('${cls}')">‚úèÔ∏è</button>
                    <button class="btn btn-danger" style="padding: 5px;" onclick="clearSingleClass('${cls}')">üóëÔ∏è</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
        calculateTotals();
    }
    
    function loadClassSelectors() {
        const selects = ['studentClass', 'lessonClass', 'resultClass', 'feeStructureClass', 'tripClasses', 'reportClass', 'timetableClass', 'removeClassSelect', 'totalFeeClass'];
        selects.forEach(id => {
            const select = document.getElementById(id);
            if (select) {
                if (id === 'tripClasses') {
                    select.innerHTML = '';
                    classList.forEach(cls => {
                        const option = document.createElement('option');
                        option.value = cls;
                        option.textContent = cls;
                        select.appendChild(option);
                    });
                } else {
                    select.innerHTML = '<option value="">Select Class</option>';
                    classList.forEach(cls => {
                        const option = document.createElement('option');
                        option.value = cls;
                        option.textContent = cls;
                        select.appendChild(option);
                    });
                }
            }
        });
    }
    
    function loadClassDropdowns() {
        const timetableClass = document.getElementById('timetableClass');
        if (timetableClass) {
            timetableClass.innerHTML = '<option value="">Select Class</option>';
            classList.forEach(cls => {
                const option = document.createElement('option');
                option.value = cls;
                option.textContent = cls;
                timetableClass.appendChild(option);
            });
        }
    }
    
    // ========== CLASS MANAGEMENT ==========
    function loadClasses() {
        const classListDiv = document.getElementById('classList');
        if (!classListDiv) return;
        
        classListDiv.innerHTML = '';
        classList.forEach(cls => {
            const div = document.createElement('div');
            div.className = 'class-item';
            div.innerHTML = `
                ${cls}
                <button onclick="removeSingleClass('${cls}')">‚úñ</button>
            `;
            classListDiv.appendChild(div);
        });
        
        document.getElementById('totalClasses').innerText = classList.length;
        document.getElementById('classTotalStudents').innerText = students.length;
        document.getElementById('avgPerClass').innerText = classList.length > 0 ? (students.length / classList.length).toFixed(1) : 0;
        document.getElementById('activeClasses').innerText = classList.length;
        
        loadClassDetails();
    }
    
    function loadClassDetails() {
        const tbody = document.getElementById('classDetailsList');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        classList.forEach(cls => {
            const classStudents = students.filter(s => s.class === cls);
            const boys = classStudents.filter(s => s.gender === 'Boy').length;
            const girls = classStudents.filter(s => s.gender === 'Girl').length;
            
            tbody.innerHTML += `
                <tr>
                    <td>${cls}</td>
                    <td>${classStudents.length}</td>
                    <td>${boys}</td>
                    <td>${girls}</td>
                    <td>${teachers.find(t => t.class === cls)?.name || 'Not Assigned'}</td>
                    <td>
                        <button class="btn btn-info" style="padding: 5px;" onclick="viewClassDetails('${cls}')">üëÅÔ∏è</button>
                    </td>
                </tr>
            `;
        });
    }
    
    function showAddClassModal() {
        document.getElementById('newClassName').value = '';
        document.getElementById('addClassModal').style.display = 'flex';
    }
    
    function addNewClass() {
        const className = document.getElementById('newClassName').value.trim();
        
        if (!className) {
            alert('Please enter class name');
            return;
        }
        
        if (classList.includes(className)) {
            alert('This class already exists!');
            return;
        }
        
        classList.push(className);
        classes.push({ name: className, streams: ["A"] });
        localStorage.setItem('classes', JSON.stringify(classes));
        
        buildTable();
        loadClassSelectors();
        loadClasses();
        loadClassDropdowns();
        closeModal('addClassModal');
        logActivity(`Added new class: ${className}`);
        showNotification('‚úÖ Class added successfully!');
    }
    
    function showRemoveClassModal() {
        const select = document.getElementById('removeClassSelect');
        select.innerHTML = '<option value="">Select Class</option>';
        classList.forEach(cls => {
            select.innerHTML += `<option value="${cls}">${cls}</option>`;
        });
        document.getElementById('removeClassModal').style.display = 'flex';
    }
    
    function removeClass() {
        const className = document.getElementById('removeClassSelect').value;
        const confirm = document.getElementById('confirmDelete').value;
        
        if (!className) {
            alert('Please select a class');
            return;
        }
        
        if (confirm !== 'DELETE') {
            alert('Please type DELETE to confirm');
            return;
        }
        
        students = students.filter(s => s.class !== className);
        localStorage.setItem('students', JSON.stringify(students));
        
        const index = classList.indexOf(className);
        if (index > -1) {
            classList.splice(index, 1);
        }
        
        classes = classes.filter(c => c.name !== className);
        localStorage.setItem('classes', JSON.stringify(classes));
        
        buildTable();
        loadClassSelectors();
        loadClasses();
        loadClassDropdowns();
        closeModal('removeClassModal');
        logActivity(`Removed class: ${className}`);
        showNotification('‚úÖ Class removed successfully!');
    }
    
    function removeSingleClass(className) {
        if (confirm(`Remove ${className}? This will also remove all students in this class.`)) {
            students = students.filter(s => s.class !== className);
            localStorage.setItem('students', JSON.stringify(students));
            
            const index = classList.indexOf(className);
            if (index > -1) {
                classList.splice(index, 1);
            }
            
            classes = classes.filter(c => c.name !== className);
            localStorage.setItem('classes', JSON.stringify(classes));
            
            buildTable();
            loadClassSelectors();
            loadClasses();
            loadClassDropdowns();
            logActivity(`Removed class: ${className}`);
            showNotification('‚úÖ Class removed');
        }
    }
    
    function refreshClassList() {
        loadClasses();
        showNotification('üîÑ Class list refreshed');
    }
    
    // ========== ROLL CALL FUNCTIONS ==========
    async function loadData() {
        const btn = document.getElementById('fetchBtn');
        if (btn) {
            btn.innerText = "‚è≥ Syncing..."; 
            btn.disabled = true;
        }
        
        try {
            if (!navigator.onLine) {
                loadOfflineData();
                showNotification('üì¥ Offline mode - using cached data');
                return;
            }
            
            const res = await fetch(SCRIPT_URL);
            const data = await res.json(); 
            
            const latestEntries = {};
            data.slice(1).forEach(row => {
                if(row[0]) latestEntries[row[0].toString().trim()] = row;
            });

            classList.forEach(cls => {
                const row = latestEntries[cls];
                const tr = document.querySelector(`tr[data-class="${cls}"]`);
                if (row && tr) {
                    const boys = parseInt(row[1]) || 0;
                    const girls = parseInt(row[2]) || 0;
                    const lunch = parseInt(row[5]) || 0;
                    const newStudents = parseInt(row[6]) || 0;
                    const nr = parseInt(row[7]) || 0;
                    const names = row[9] || "-";
                    
                    const nameCount = names === "-" ? 0 : names.split(',').length;
                    
                    tr.querySelector('.c-b').innerText = boys;
                    tr.querySelector('.c-g').innerText = girls;
                    tr.querySelector('.c-t').innerText = boys + girls;
                    tr.querySelector('.c-l').innerText = lunch;
                    tr.querySelector('.c-n').innerText = newStudents;
                    tr.querySelector('.c-nr').innerText = nr;
                    tr.querySelector('.c-a').innerText = nameCount;
                    tr.querySelector('.c-names').innerText = names;
                    
                    saveToHistory(cls, {
                        date: new Date().toISOString(),
                        boys: boys,
                        girls: girls,
                        total: boys + girls,
                        absent: nameCount
                    });
                    
                    if(row[10]) {
                        document.getElementById('syncTime').innerText = "Last Updated: " + new Date(row[10]).toLocaleString();
                    }
                }
            });
            
            localStorage.setItem('lastAttendance', JSON.stringify({
                data: latestEntries,
                timestamp: new Date().toISOString()
            }));
            
            calculateTotals();
            updateStatistics();
            logActivity('Synced attendance data');
            showNotification('‚úÖ Data synced successfully!');
            
        } catch (e) { 
            console.error('Fetch error:', e);
            alert("‚ö†Ô∏è Fetch failed. Loading offline data..."); 
            loadOfflineData();
        } finally { 
            if (btn) {
                btn.innerText = "üîÑ FETCH DAILY DATA"; 
                btn.disabled = false; 
            }
        }
    }
    
    function loadOfflineData() {
        const cached = localStorage.getItem('lastAttendance');
        if (cached) {
            const data = JSON.parse(cached);
            document.getElementById('syncTime').innerText = "Offline data from: " + new Date(data.timestamp).toLocaleString();
            
            classList.forEach(cls => {
                const row = data.data[cls];
                const tr = document.querySelector(`tr[data-class="${cls}"]`);
                if (row && tr) {
                    const boys = parseInt(row[1]) || 0;
                    const girls = parseInt(row[2]) || 0;
                    const lunch = parseInt(row[5]) || 0;
                    const newStudents = parseInt(row[6]) || 0;
                    const nr = parseInt(row[7]) || 0;
                    const names = row[9] || "-";
                    
                    const nameCount = names === "-" ? 0 : names.split(',').length;
                    
                    tr.querySelector('.c-b').innerText = boys;
                    tr.querySelector('.c-g').innerText = girls;
                    tr.querySelector('.c-t').innerText = boys + girls;
                    tr.querySelector('.c-l').innerText = lunch;
                    tr.querySelector('.c-n').innerText = newStudents;
                    tr.querySelector('.c-nr').innerText = nr;
                    tr.querySelector('.c-a').innerText = nameCount;
                    tr.querySelector('.c-names').innerText = names;
                }
            });
        } else {
            showNotification('‚ùå No cached data available');
        }
        calculateTotals();
    }
    
    function saveToHistory(cls, data) {
        attendanceHistory.push({ class: cls, ...data });
        if (attendanceHistory.length > 1000) {
            attendanceHistory = attendanceHistory.slice(-1000);
        }
        localStorage.setItem('attendanceHistory', JSON.stringify(attendanceHistory));
    }
    
    function calculateTotals() {
        let b=0, g=0, t=0, l=0, n=0, nr=0, a=0;
        document.querySelectorAll('#rollTable tr').forEach(r => {
            b += parseInt(r.querySelector('.c-b').innerText) || 0;
            g += parseInt(r.querySelector('.c-g').innerText) || 0;
            t += parseInt(r.querySelector('.c-t').innerText) || 0;
            l += parseInt(r.querySelector('.c-l').innerText) || 0;
            n += parseInt(r.querySelector('.c-n').innerText) || 0;
            nr += parseInt(r.querySelector('.c-nr').innerText) || 0;
            a += parseInt(r.querySelector('.c-a').innerText) || 0;
        });
        
        document.getElementById('gBoys').innerText = b; 
        document.getElementById('gGirls').innerText = g;
        document.getElementById('gTotal').innerText = t; 
        document.getElementById('gLunch').innerText = l;
        document.getElementById('gNew').innerText = n; 
        document.getElementById('gNR').innerText = nr;
        document.getElementById('gAbs').innerText = a;
    }
    
    function updateStatistics() {
        document.getElementById('statTotalReg').innerText = students.length;
        
        const total = parseInt(document.getElementById('gTotal').innerText) || 0;
        const absent = parseInt(document.getElementById('gAbs').innerText) || 0;
        const present = total - absent;
        const percent = total > 0 ? ((present / total) * 100).toFixed(1) : 0;
        
        document.getElementById('statPresent').innerText = present;
        document.getElementById('statAbsent').innerText = absent;
        document.getElementById('statPercent').innerText = percent + '%';
    }
    
    function clearCurrentRow() {
        const selectedRow = document.querySelector('#rollTable tr.selected');
        if (!selectedRow) {
            alert('Please click on a row first to select it, or use the edit button to clear specific fields');
            return;
        }
        
        if (confirm('Clear data for this row?')) {
            selectedRow.querySelector('.c-b').innerText = '0';
            selectedRow.querySelector('.c-g').innerText = '0';
            selectedRow.querySelector('.c-t').innerText = '0';
            selectedRow.querySelector('.c-l').innerText = '0';
            selectedRow.querySelector('.c-n').innerText = '0';
            selectedRow.querySelector('.c-nr').innerText = '0';
            selectedRow.querySelector('.c-a').innerText = '0';
            selectedRow.querySelector('.c-names').innerText = '-';
            
            calculateTotals();
            updateStatistics();
            showNotification('‚úÖ Row cleared');
        }
    }
    
    document.addEventListener('click', function(e) {
        const row = e.target.closest('tr');
        if (row && row.closest('#rollTable')) {
            document.querySelectorAll('#rollTable tr').forEach(r => r.classList.remove('selected'));
            row.classList.add('selected');
        }
    });
    
    function showClearAllModal() {
        document.getElementById('confirmClearAll').value = '';
        document.getElementById('clearAllRollCallModal').style.display = 'flex';
    }
    
    async function clearAllRollCallData() {
        const confirm = document.getElementById('confirmClearAll').value;
        
        if (confirm !== 'CLEAR ALL') {
            alert('Please type CLEAR ALL to confirm');
            return;
        }
        
        const btn = document.getElementById('fetchBtn');
        if (btn) {
            btn.innerText = "‚è≥ Clearing..."; 
            btn.disabled = true;
        }
        
        try {
            alert('‚ö†Ô∏è This is a demo. In production, this would connect to Google Sheets API to clear all data.\n\nFor now, clearing local data only.');
            
            document.querySelectorAll('#rollTable tr').forEach(row => {
                row.querySelector('.c-b').innerText = '0';
                row.querySelector('.c-g').innerText = '0';
                row.querySelector('.c-t').innerText = '0';
                row.querySelector('.c-l').innerText = '0';
                row.querySelector('.c-n').innerText = '0';
                row.querySelector('.c-nr').innerText = '0';
                row.querySelector('.c-a').innerText = '0';
                row.querySelector('.c-names').innerText = '-';
            });
            
            calculateTotals();
            updateStatistics();
            localStorage.removeItem('lastAttendance');
            document.getElementById('syncTime').innerText = 'Last Updated: Never';
            
            closeModal('clearAllRollCallModal');
            logActivity('Cleared all roll call data');
            showNotification('‚úÖ All roll call data cleared');
            
        } catch (e) {
            console.error('Clear error:', e);
            alert('‚ùå Failed to clear data');
        } finally {
            if (btn) {
                btn.innerText = "üîÑ FETCH DAILY DATA"; 
                btn.disabled = false; 
            }
        }
    }
    
    function clearSingleClass(className) {
        if (confirm(`Clear all data for ${className}?`)) {
            const row = document.querySelector(`tr[data-class="${className}"]`);
            if (row) {
                row.querySelector('.c-b').innerText = '0';
                row.querySelector('.c-g').innerText = '0';
                row.querySelector('.c-t').innerText = '0';
                row.querySelector('.c-l').innerText = '0';
                row.querySelector('.c-n').innerText = '0';
                row.querySelector('.c-nr').innerText = '0';
                row.querySelector('.c-a').innerText = '0';
                row.querySelector('.c-names').innerText = '-';
                
                calculateTotals();
                updateStatistics();
                showNotification(`‚úÖ ${className} cleared`);
            }
        }
    }
    
    // ========== STUDENT MANAGEMENT ==========
    function loadStudents() {
        const tbody = document.getElementById('studentsList');
        if (!tbody) return;
        
        let boys = 0, girls = 0, withBalance = 0;
        tbody.innerHTML = '';
        students.forEach((student, index) => {
            if (student.gender === 'Boy') boys++;
            else if (student.gender === 'Girl') girls++;
            
            const balance = calculateStudentBalance(student.admission);
            if (balance > 0) withBalance++;
            
            tbody.innerHTML += `
                <tr onclick="viewStudentReport('${student.admission}')" style="cursor: pointer;">
                    <td>${student.admission || 'N/A'}</td>
                    <td>${student.name || ''}</td>
                    <td>${student.class || ''}</td>
                    <td>${student.gender || ''}</td>
                    <td>${student.route || 'Boarder'}</td>
                    <td>${student.parentName || ''}</td>
                    <td>${student.parentPhone || ''}</td>
                    <td>${student.parentEmail || '-'}</td>
                    <td>KSh ${balance.toLocaleString()}</td>
                    <td>
                        <button class="btn btn-primary" style="padding: 5px;" onclick="event.stopPropagation(); editStudent('${student.admission}')">‚úèÔ∏è</button>
                        <button class="btn btn-danger" style="padding: 5px;" onclick="event.stopPropagation(); deleteStudent('${student.admission}')">üóëÔ∏è</button>
                        <button class="btn btn-success" style="padding: 5px;" onclick="event.stopPropagation(); quickFeePayment('${student.admission}')">üí∞</button>
                    </td>
                </tr>
            `;
        });
        
        document.getElementById('studentCount').innerText = students.length;
        document.getElementById('studentBoys').innerText = boys;
        document.getElementById('studentGirls').innerText = girls;
        document.getElementById('studentsWithBalance').innerText = withBalance;
    }
    
    function showAddStudentModal() {
        editingIndex = -1;
        document.getElementById('modalTitle').innerText = '‚ûï Add New Student';
        document.getElementById('studentAdmission').value = generateAdmissionNumber();
        document.getElementById('studentName').value = '';
        document.getElementById('studentClass').value = '';
        document.getElementById('studentGender').value = 'Boy';
        document.getElementById('studentRoute').value = '';
        document.getElementById('parentName').value = '';
        document.getElementById('parentPhone').value = '';
        document.getElementById('parentEmail').value = '';
        document.getElementById('studentModal').style.display = 'flex';
    }
    
    function generateAdmissionNumber() {
        const year = new Date().getFullYear();
        const count = students.length + 1;
        return `STU${year}${count.toString().padStart(4, '0')}`;
    }
    
    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }
    
    function saveStudent() {
        const admission = document.getElementById('studentAdmission').value.trim();
        const name = document.getElementById('studentName').value.trim();
        const studentClass = document.getElementById('studentClass').value;
        
        if (!admission || !name || !studentClass) {
            alert('‚ùå Please fill all required fields');
            return;
        }
        
        if (editingIndex >= 0) {
            const existingIndex = students.findIndex(s => s.admission === admission);
            if (existingIndex !== -1 && existingIndex !== editingIndex) {
                alert('‚ùå Admission number already exists');
                return;
            }
        } else {
            if (students.some(s => s.admission === admission)) {
                alert('‚ùå Admission number already exists');
                return;
            }
        }
        
        const student = {
            admission: admission,
            name: name,
            class: studentClass,
            gender: document.getElementById('studentGender').value,
            route: document.getElementById('studentRoute').value.trim() || 'Boarder',
            parentName: document.getElementById('parentName').value.trim(),
            parentPhone: document.getElementById('parentPhone').value.trim(),
            parentEmail: document.getElementById('parentEmail').value.trim()
        };
        
        if (editingIndex >= 0) {
            students[editingIndex] = student;
            logActivity(`Updated student: ${name}`);
            showNotification('‚úÖ Student updated successfully!');
        } else {
            students.push(student);
            logActivity(`Added student: ${name}`);
            showNotification('‚úÖ Student added successfully!');
        }
        
        localStorage.setItem('students', JSON.stringify(students));
        loadStudents();
        loadClasses();
        closeModal('studentModal');
    }
    
    function editStudent(admission) {
        const index = students.findIndex(s => s.admission === admission);
        if (index === -1) return;
        
        editingIndex = index;
        const student = students[index];
        document.getElementById('modalTitle').innerText = '‚úèÔ∏è Edit Student';
        document.getElementById('studentAdmission').value = student.admission || '';
        document.getElementById('studentName').value = student.name || '';
        document.getElementById('studentClass').value = student.class || '';
        document.getElementById('studentGender').value = student.gender || 'Boy';
        document.getElementById('studentRoute').value = student.route || '';
        document.getElementById('parentName').value = student.parentName || '';
        document.getElementById('parentPhone').value = student.parentPhone || '';
        document.getElementById('parentEmail').value = student.parentEmail || '';
        
        document.getElementById('studentModal').style.display = 'flex';
    }
    
    function deleteStudent(admission) {
        if (confirm('‚ö†Ô∏è Are you sure you want to delete this student?')) {
            students = students.filter(s => s.admission !== admission);
            localStorage.setItem('students', JSON.stringify(students));
            loadStudents();
            loadClasses();
            logActivity(`Deleted student: ${admission}`);
            showNotification('‚úÖ Student deleted');
        }
    }
    
    function filterStudents() {
        const search = document.getElementById('searchStudents').value.toUpperCase();
        document.querySelectorAll('#studentsList tr').forEach(tr => {
            const text = tr.innerText.toUpperCase();
            tr.style.display = text.includes(search) ? '' : 'none';
        });
    }
    
    function showBulkImportModal() {
        document.getElementById('importData').value = '';
        document.getElementById('importModal').style.display = 'flex';
    }
    
    function importStudents() {
        const data = document.getElementById('importData').value;
        const lines = data.split('\n');
        let count = 0;
        
        lines.forEach(line => {
            if (line.trim()) {
                const parts = line.split(',');
                if (parts.length >= 2) {
                    const admission = parts[0].trim() || generateAdmissionNumber();
                    if (!students.some(s => s.admission === admission)) {
                        students.push({
                            admission: admission,
                            name: parts[1].trim(),
                            class: parts[2]?.trim() || '',
                            gender: parts[3]?.trim() || 'Boy',
                            route: parts[4]?.trim() || 'Boarder',
                            parentName: parts[5]?.trim() || '',
                            parentPhone: parts[6]?.trim() || '',
                            parentEmail: parts[7]?.trim() || ''
                        });
                        count++;
                    }
                }
            }
        });
        
        if (count > 0) {
            localStorage.setItem('students', JSON.stringify(students));
            loadStudents();
            loadClasses();
            logActivity(`Imported ${count} students`);
            showNotification(`‚úÖ Imported ${count} students!`);
        } else {
            alert('‚ùå No valid data found');
        }
        closeModal('importModal');
    }
    
    function exportStudents() {
        if (students.length === 0) {
            alert('No students to export');
            return;
        }
        
        const data = students.map(s => 
            `${s.admission},${s.name},${s.class},${s.gender},${s.route},${s.parentName},${s.parentPhone},${s.parentEmail}`
        ).join('\n');
        
        const blob = new Blob([data], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `students_${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        showNotification('üì• Students exported');
    }
    
    // ========== PARENT MANAGEMENT ==========
    function searchParents() {
        const search = document.getElementById('searchParents').value.toLowerCase();
        if (search.length < 2) return;
        
        const parentMap = new Map();
        students.forEach(s => {
            if (s.parentName && s.parentName.toLowerCase().includes(search)) {
                if (!parentMap.has(s.parentName)) {
                    parentMap.set(s.parentName, {
                        name: s.parentName,
                        phone: s.parentPhone,
                        email: s.parentEmail,
                        children: []
                    });
                }
                parentMap.get(s.parentName).children.push(s);
            }
        });
        
        const resultsDiv = document.getElementById('parentSearchResults');
        resultsDiv.innerHTML = '<h4>Search Results</h4>';
        
        if (parentMap.size === 0) {
            resultsDiv.innerHTML += '<p>No parents found</p>';
            return;
        }
        
        parentMap.forEach((parent, name) => {
            const parentDiv = document.createElement('div');
            parentDiv.className = 'parent-card';
            parentDiv.innerHTML = `
                <strong>${name}</strong><br>
                üìû ${parent.phone || 'N/A'} | üìß ${parent.email || 'N/A'}<br>
                üë• ${parent.children.length} children
                <button class="btn btn-info" style="margin-top: 10px;" onclick="showParentChildren('${name}')">View Children</button>
                <button class="btn btn-primary" style="margin-top: 10px;" onclick="sendEmailToParent('${name}')">üìß Email</button>
            `;
            resultsDiv.appendChild(parentDiv);
        });
        
        document.getElementById('totalParents').innerText = parentMap.size;
        document.getElementById('parentsWithEmail').innerText = Array.from(parentMap.values()).filter(p => p.email).length;
        document.getElementById('parentsWithPhone').innerText = Array.from(parentMap.values()).filter(p => p.phone).length;
        document.getElementById('avgChildren').innerText = parentMap.size > 0 ? (students.length / parentMap.size).toFixed(1) : 0;
    }
    
    function showParentChildren(parentName) {
        const children = students.filter(s => s.parentName === parentName);
        const childrenDiv = document.getElementById('parentChildrenList');
        childrenDiv.innerHTML = `
            <h4>Children of ${parentName}</h4>
            <table>
                <thead>
                    <tr>
                        <th>Admission</th>
                        <th>Name</th>
                        <th>Class</th>
                        <th>Gender</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${children.map(child => `
                        <tr>
                            <td>${child.admission}</td>
                            <td>${child.name}</td>
                            <td>${child.class}</td>
                            <td>${child.gender}</td>
                            <td>
                                <button class="btn btn-info" onclick="viewStudentReport('${child.admission}')">üìÑ Report</button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    }
    
    function sendEmailToParent(parentName) {
        const parent = students.find(s => s.parentName === parentName);
        if (!parent) return;
        
        document.getElementById('emailParentName').value = parentName;
        document.getElementById('emailParentAddress').value = parent.parentEmail || '';
        
        const children = students.filter(s => s.parentName === parentName);
        const childSelect = document.getElementById('emailChildSelect');
        childSelect.innerHTML = '<option value="">Select Child</option>';
        children.forEach(child => {
            childSelect.innerHTML += `<option value="${child.admission}">${child.name} (${child.class})</option>`;
        });
        
        document.getElementById('parentEmailModal').style.display = 'flex';
    }
    
    function attachReportToEmail() {
        const childAdmission = document.getElementById('emailChildSelect').value;
        if (!childAdmission) {
            alert('Please select a child');
            return;
        }
        
        const report = generateStudentReportHTML(childAdmission);
        document.getElementById('emailMessage').value += '\n\n' + report.replace(/<[^>]*>/g, ' ').substring(0, 500) + '...';
        alert('Report attached to email');
    }
    
    async function sendParentEmail() {
        const to = document.getElementById('emailParentAddress').value;
        const subject = document.getElementById('emailSubject').value;
        const message = document.getElementById('emailMessage').value;
        const childAdmission = document.getElementById('emailChildSelect').value;
        
        if (!to) {
            alert('Parent email not available');
            return;
        }
        
        let fullMessage = message;
        if (childAdmission) {
            const report = generateStudentReportHTML(childAdmission);
            fullMessage += '\n\n--- Student Report ---\n' + report.replace(/<[^>]*>/g, ' ');
        }
        
        const sent = await sendEmailJS(to, subject, fullMessage);
        
        if (sent) {
            alert(`‚úÖ Email sent to ${to}`);
            logActivity(`Email sent to ${to}`);
            showNotification('‚úÖ Email sent!');
            closeModal('parentEmailModal');
        }
    }
    
    function exportParents() {
        const parentMap = new Map();
        students.forEach(s => {
            if (s.parentName) {
                if (!parentMap.has(s.parentName)) {
                    parentMap.set(s.parentName, {
                        name: s.parentName,
                        phone: s.parentPhone,
                        email: s.parentEmail,
                        children: []
                    });
                }
                parentMap.get(s.parentName).children.push(s);
            }
        });
        
        const data = Array.from(parentMap.values()).map(p => 
            `${p.name},${p.phone || ''},${p.email || ''},${p.children.length},"${p.children.map(c => c.name).join('; ')}"`
        ).join('\n');
        
        const blob = new Blob([data], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `parents_${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        showNotification('üì• Parents exported');
    }
    
    // ========== TEACHER MANAGEMENT ==========
    function loadTeachers() {
        const tbody = document.getElementById('teachersList');
        if (!tbody) return;
        
        let male = 0, female = 0, withEmail = 0;
        tbody.innerHTML = '';
        teachers.forEach((teacher, index) => {
            if (teacher.gender === 'Male') male++;
            else if (teacher.gender === 'Female') female++;
            if (teacher.email) withEmail++;
            
            tbody.innerHTML += `
                <tr>
                    <td>${teacher.tsc || 'N/A'}</td>
                    <td>${teacher.name || ''}</td>
                    <td>${teacher.gender || ''}</td>
                    <td>${teacher.subject || ''}</td>
                    <td>${teacher.phone || ''}</td>
                    <td>${teacher.email || '-'}</td>
                    <td>${teacher.qualification || ''}</td>
                    <td>
                        <button class="btn btn-primary" style="padding: 5px;" onclick="editTeacher('${teacher.tsc}')">‚úèÔ∏è</button>
                        <button class="btn btn-danger" style="padding: 5px;" onclick="deleteTeacher('${teacher.tsc}')">üóëÔ∏è</button>
                    </td>
                </tr>
            `;
        });
        
        const teacherSelects = document.querySelectorAll('#lessonTeacher, #tripTeacher');
        teacherSelects.forEach(select => {
            if (select) {
                select.innerHTML = '<option value="">Select Teacher</option>';
                teachers.forEach(t => {
                    select.innerHTML += `<option value="${t.tsc}">${t.name} (${t.subject})</option>`;
                });
            }
        });
        
        document.getElementById('teacherCount').innerText = teachers.length;
        document.getElementById('teacherMale').innerText = male;
        document.getElementById('teacherFemale').innerText = female;
        document.getElementById('teacherWithEmail').innerText = withEmail;
        document.getElementById('teacherTotal').innerText = teachers.length;
    }
    
    function showAddTeacherModal() {
        document.getElementById('teacherTSC').value = generateTSCNumber();
        document.getElementById('teacherName').value = '';
        document.getElementById('teacherGender').value = '';
        document.getElementById('teacherSubject').value = '';
        document.getElementById('teacherPhone').value = '';
        document.getElementById('teacherEmail').value = '';
        document.getElementById('teacherQualification').value = '';
        document.getElementById('teacherModal').style.display = 'flex';
    }
    
    function generateTSCNumber() {
        const year = new Date().getFullYear();
        const count = teachers.length + 1;
        return `TSC${year}${count.toString().padStart(4, '0')}`;
    }
    
    function saveTeacher() {
        const tsc = document.getElementById('teacherTSC').value.trim();
        const name = document.getElementById('teacherName').value.trim();
        const gender = document.getElementById('teacherGender').value;
        
        if (!tsc || !name || !gender) {
            alert('‚ùå Please fill TSC number, name and gender');
            return;
        }
        
        const teacher = {
            tsc: tsc,
            name: name,
            gender: gender,
            subject: document.getElementById('teacherSubject').value.trim(),
            phone: document.getElementById('teacherPhone').value.trim(),
            email: document.getElementById('teacherEmail').value.trim(),
            qualification: document.getElementById('teacherQualification').value.trim()
        };
        
        teachers.push(teacher);
        localStorage.setItem('teachers', JSON.stringify(teachers));
        loadTeachers();
        closeModal('teacherModal');
        logActivity(`Added teacher: ${name}`);
        showNotification('‚úÖ Teacher added successfully!');
    }
    
    function editTeacher(tsc) {
        alert('Edit teacher functionality - To be implemented');
    }
    
    function deleteTeacher(tsc) {
        if (confirm('‚ö†Ô∏è Are you sure you want to delete this teacher?')) {
            teachers = teachers.filter(t => t.tsc !== tsc);
            localStorage.setItem('teachers', JSON.stringify(teachers));
            loadTeachers();
            logActivity(`Deleted teacher: ${tsc}`);
            showNotification('‚úÖ Teacher deleted');
        }
    }
    
    function filterTeachers() {
        const search = document.getElementById('searchTeachers').value.toUpperCase();
        document.querySelectorAll('#teachersList tr').forEach(tr => {
            const text = tr.innerText.toUpperCase();
            tr.style.display = text.includes(search) ? '' : 'none';
        });
    }
    
    function exportTeachers() {
        if (teachers.length === 0) {
            alert('No teachers to export');
            return;
        }
        
        const data = teachers.map(t => 
            `${t.tsc},${t.name},${t.gender},${t.subject},${t.phone},${t.email},${t.qualification}`
        ).join('\n');
        
        const blob = new Blob([data], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `teachers_${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        showNotification('üì• Teachers exported');
    }
    
    // ========== LESSON/TIMETABLE MANAGEMENT ==========
    function loadLessons() {
        const teacherSelect = document.getElementById('lessonTeacher');
        if (teacherSelect) {
            teacherSelect.innerHTML = '<option value="">Select Teacher</option>';
            teachers.forEach(t => {
                teacherSelect.innerHTML += `<option value="${t.tsc}">${t.name}</option>`;
            });
        }
    }
    
    function showAddLessonModal() {
        document.getElementById('lessonModal').style.display = 'flex';
    }
    
    function saveLesson() {
        const teacher = document.getElementById('lessonTeacher').value;
        const className = document.getElementById('lessonClass').value;
        const subject = document.getElementById('lessonSubject').value.trim();
        const day = document.getElementById('lessonDay').value;
        const startTime = document.getElementById('lessonStartTime').value;
        const endTime = document.getElementById('lessonEndTime').value;
        
        if (!teacher || !className || !subject) {
            alert('‚ùå Please fill all required fields');
            return;
        }
        
        const lesson = {
            id: Date.now(),
            teacher: teacher,
            teacherName: teachers.find(t => t.tsc === teacher)?.name || teacher,
            class: className,
            subject: subject,
            day: day,
            startTime: startTime,
            endTime: endTime,
            timestamp: new Date().toISOString()
        };
        
        lessons.unshift(lesson); // Add to beginning for most recent first
        localStorage.setItem('lessons', JSON.stringify(lessons));
        closeModal('lessonModal');
        logActivity(`Added lesson: ${subject} for ${className}`);
        showNotification('‚úÖ Lesson added successfully!');
        generateTimetable();
    }
    
    function generateTimetable() {
        const className = document.getElementById('timetableClass').value;
        if (!className) {
            document.getElementById('timetableContainer').innerHTML = '<p>Please select a class</p>';
            return;
        }
        
        document.getElementById('timetableClassDisplay').innerText = `Class: ${className}`;
        
        // Sort lessons by most recent first (for display purposes)
        const classLessons = lessons.filter(l => l.class === className).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        
        let html = '<div class="timetable-header">Time</div>';
        days.forEach(day => {
            html += `<div class="timetable-header">${day}</div>`;
        });
        
        timeSlots.forEach(timeSlot => {
            const [start, end] = timeSlot.split('-');
            html += `<div class="timetable-cell timetable-time">${timeSlot}</div>`;
            
            days.forEach(day => {
                const lesson = classLessons.find(l => l.day === day && l.startTime <= start && l.endTime >= end);
                html += `<div class="timetable-cell">`;
                if (lesson) {
                    html += `<strong>${lesson.subject}</strong><br>${lesson.teacherName}`;
                } else {
                    html += `-`;
                }
                html += `</div>`;
            });
        });
        
        document.getElementById('timetableContainer').innerHTML = html;
    }
    
    function validateTimetable() {
        const className = document.getElementById('timetableClass').value;
        if (!className) {
            alert('Please select a class');
            return;
        }
        
        const classLessons = lessons.filter(l => l.class === className);
        let conflicts = [];
        
        days.forEach(day => {
            const dayLessons = classLessons.filter(l => l.day === day);
            for (let i = 0; i < dayLessons.length; i++) {
                for (let j = i + 1; j < dayLessons.length; j++) {
                    if (dayLessons[i].startTime < dayLessons[j].endTime && dayLessons[j].startTime < dayLessons[i].endTime) {
                        conflicts.push(`Time conflict on ${day}: ${dayLessons[i].subject} and ${dayLessons[j].subject}`);
                    }
                }
            }
        });
        
        if (conflicts.length > 0) {
            alert('‚ö†Ô∏è Timetable conflicts found:\n' + conflicts.join('\n'));
        } else {
            showNotification('‚úÖ Timetable is valid!');
        }
    }
    
    // ========== EXAM MANAGEMENT ==========
    function loadExams() {
        const tbody = document.getElementById('examsList');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        exams.forEach((exam, index) => {
            const results = examResults.filter(r => r.examId === exam.id);
            const mean = results.length > 0 ? (results.reduce((sum, r) => sum + r.score, 0) / results.length).toFixed(1) : '-';
            
            tbody.innerHTML += `
                <tr>
                    <td>${exam.name}</td>
                    <td>Term ${exam.term}</td>
                    <td>${exam.year}</td>
                    <td>${exam.class || 'All'}</td>
                    <td>${exam.subject || 'All'}</td>
                    <td>${results.length}</td>
                    <td>${mean}%</td>
                    <td>
                        <button class="btn btn-primary" style="padding: 5px;" onclick="viewExamResults('${exam.id}')">üëÅÔ∏è</button>
                        <button class="btn btn-danger" style="padding: 5px;" onclick="deleteExam('${exam.id}')">üóëÔ∏è</button>
                    </td>
                </tr>
            `;
        });
        
        const examFilter = document.getElementById('examFilter');
        if (examFilter) {
            examFilter.innerHTML = '<option value="">All Exams</option>';
            exams.forEach(e => {
                examFilter.innerHTML += `<option value="${e.id}">${e.name}</option>`;
            });
        }
        
        const resultExam = document.getElementById('resultExam');
        if (resultExam) {
            resultExam.innerHTML = '<option value="">Select Exam</option>';
            exams.forEach(e => {
                resultExam.innerHTML += `<option value="${e.id}">${e.name} (Term ${e.term} ${e.year})</option>`;
            });
        }
        
        updateExamStats();
        loadExamResults();
    }
    
    function loadExamResults() {
        const tbody = document.getElementById('examResultsList');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        examResults.sort((a, b) => b.score - a.score).forEach((result, index) => {
            const exam = exams.find(e => e.id === result.examId);
            const student = students.find(s => s.admission === result.admission);
            const grade = calculateGrade(result.score);
            const gradeClass = `grade-${grade.toLowerCase()}`;
            
            tbody.innerHTML += `
                <tr>
                    <td>${exam?.name || 'N/A'}</td>
                    <td>${result.admission}</td>
                    <td>${student?.name || 'N/A'}</td>
                    <td>${result.class}</td>
                    <td>${result.subject}</td>
                    <td>${result.score}%</td>
                    <td class="${gradeClass}">${grade}</td>
                    <td>${index + 1}</td>
                    <td>
                        <button class="btn btn-danger" style="padding: 5px;" onclick="showDeleteExamResult('${result.id}')">üóëÔ∏è</button>
                    </td>
                </tr>
            `;
        });
    }
    
    function showAddExamModal() {
        document.getElementById('examName').value = '';
        document.getElementById('examTerm').value = settings.currentTerm;
        document.getElementById('examYear').value = settings.academicYear;
        document.getElementById('examStartDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('examEndDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('examModal').style.display = 'flex';
    }
    
    function saveExam() {
        const name = document.getElementById('examName').value.trim();
        if (!name) {
            alert('‚ùå Please enter exam name');
            return;
        }
        
        const exam = {
            id: Date.now().toString(),
            name: name,
            term: document.getElementById('examTerm').value,
            year: document.getElementById('examYear').value,
            startDate: document.getElementById('examStartDate').value,
            endDate: document.getElementById('examEndDate').value
        };
        
        exams.push(exam);
        localStorage.setItem('exams', JSON.stringify(exams));
        loadExams();
        closeModal('examModal');
        logActivity(`Created exam: ${name}`);
        showNotification('‚úÖ Exam added successfully!');
    }
    
    function deleteExam(id) {
        if (confirm('‚ö†Ô∏è Delete this exam and all its results?')) {
            exams = exams.filter(e => e.id !== id);
            examResults = examResults.filter(r => r.examId !== id);
            localStorage.setItem('exams', JSON.stringify(exams));
            localStorage.setItem('examResults', JSON.stringify(examResults));
            loadExams();
            logActivity(`Deleted exam: ${id}`);
            showNotification('‚úÖ Exam deleted');
        }
    }
    
    function showAddExamResultModal() {
        loadExamStudents();
        document.getElementById('examResultModal').style.display = 'flex';
    }
    
    function loadExamStudents() {
        const examId = document.getElementById('resultExam').value;
        const className = document.getElementById('resultClass').value;
        
        if (!examId || !className) return;
        
        const classStudents = students.filter(s => s.class === className);
        const container = document.getElementById('studentResultsContainer');
        
        let html = '<h4>Enter Student Scores</h4>';
        classStudents.forEach(student => {
            const existingResult = examResults.find(r => r.examId === examId && r.admission === student.admission);
            html += `
                <div style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;">
                    <span style="width: 150px;">${student.admission}</span>
                    <span style="width: 200px;">${student.name}</span>
                    <input type="number" id="score-${student.admission}" value="${existingResult?.score || ''}" placeholder="Score %" min="0" max="100" style="width: 100px;">
                    <input type="text" id="grade-${student.admission}" value="${existingResult?.grade || ''}" placeholder="Grade" readonly style="width: 60px;">
                </div>
            `;
        });
        
        container.innerHTML = html;
    }
    
    function saveExamResults() {
        const examId = document.getElementById('resultExam').value;
        const className = document.getElementById('resultClass').value;
        const subject = document.getElementById('resultSubject').value.trim();
        
        if (!examId || !className || !subject) {
            alert('‚ùå Please select exam, class and subject');
            return;
        }
        
        const classStudents = students.filter(s => s.class === className);
        
        classStudents.forEach(student => {
            const scoreInput = document.getElementById(`score-${student.admission}`);
            if (scoreInput && scoreInput.value) {
                const score = parseInt(scoreInput.value);
                const grade = calculateGrade(score);
                
                const existingIndex = examResults.findIndex(r => 
                    r.examId === examId && r.admission === student.admission && r.subject === subject
                );
                
                const result = {
                    id: existingIndex >= 0 ? examResults[existingIndex].id : Date.now() + Math.random().toString(),
                    examId: examId,
                    admission: student.admission,
                    class: className,
                    subject: subject,
                    score: score,
                    grade: grade
                };
                
                if (existingIndex >= 0) {
                    examResults[existingIndex] = result;
                } else {
                    examResults.push(result);
                }
            }
        });
        
        localStorage.setItem('examResults', JSON.stringify(examResults));
        loadExamResults();
        closeModal('examResultModal');
        logActivity(`Saved exam results for ${className}`);
        showNotification('‚úÖ Exam results saved!');
    }
    
    function calculateGrade(score) {
        if (score >= 80) return 'EE';
        if (score >= 70) return 'ME';
        if (score >= 60) return 'AE';
        if (score >= 50) return 'BE';
        return 'BE';
    }
    
    function updateExamStats() {
        document.getElementById('examCount').innerText = exams.length;
        
        const termResults = examResults.filter(r => {
            const exam = exams.find(e => e.id === r.examId);
            return exam && exam.term === settings.currentTerm;
        });
        
        const avgScore = termResults.length > 0 
            ? (termResults.reduce((sum, r) => sum + r.score, 0) / termResults.length).toFixed(1) 
            : 0;
        document.getElementById('avgScore').innerText = avgScore + '%';
        
        const topResult = termResults.sort((a, b) => b.score - a.score)[0];
        if (topResult) {
            const student = students.find(s => s.admission === topResult.admission);
            document.getElementById('topPerformer').innerText = student?.name || 'N/A';
        }
        
        const classScores = {};
        termResults.forEach(r => {
            if (!classScores[r.class]) {
                classScores[r.class] = { total: 0, count: 0 };
            }
            classScores[r.class].total += r.score;
            classScores[r.class].count++;
        });
        
        let bestClass = '-';
        let bestAvg = 0;
        Object.keys(classScores).forEach(cls => {
            const avg = classScores[cls].total / classScores[cls].count;
            if (avg > bestAvg) {
                bestAvg = avg;
                bestClass = cls;
            }
        });
        document.getElementById('bestExamClass').innerText = bestClass;
    }
    
    function filterExams() {
        const filter = document.getElementById('examFilter').value;
    }
    
    function exportExamResults() {
        if (examResults.length === 0) {
            alert('No exam results to export');
            return;
        }
        
        const data = examResults.map(r => {
            const exam = exams.find(e => e.id === r.examId);
            const student = students.find(s => s.admission === r.admission);
            return `${exam?.name},${r.admission},${student?.name},${r.class},${r.subject},${r.score},${r.grade}`;
        }).join('\n');
        
        const blob = new Blob([data], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `exam_results_${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        showNotification('üì• Exam results exported');
    }
    
    function searchExamStudent() {
        const search = document.getElementById('searchExamStudent').value.toLowerCase();
        if (search.length < 2) {
            document.getElementById('examStudentSearchResults').innerHTML = '';
            return;
        }
        
        const matches = students.filter(s => 
            s.name.toLowerCase().includes(search) || 
            s.admission.toLowerCase().includes(search)
        );
        
        const resultsDiv = document.getElementById('examStudentSearchResults');
        resultsDiv.innerHTML = '<h4>Student Search Results (click to view report)</h4>';
        
        matches.forEach(student => {
            const div = document.createElement('div');
            div.className = 'student-search-item';
            div.innerHTML = `${student.admission} - ${student.name} (${student.class})`;
            div.onclick = () => viewStudentReport(student.admission);
            resultsDiv.appendChild(div);
        });
    }
    
    function viewStudentReport(admission) {
        const student = students.find(s => s.admission === admission);
        if (!student) return;
        
        const reportHTML = generateStudentReportHTML(admission);
        document.getElementById('studentReportContent').innerHTML = reportHTML;
        document.getElementById('studentReportModal').style.display = 'flex';
    }
    
    function generateStudentReportHTML(admission) {
        const student = students.find(s => s.admission === admission);
        const studentResults = examResults.filter(r => r.admission === admission);
        
        let html = `
            <div style="text-align: center; margin-bottom: 20px;">
                <h2>${settings.schoolName}</h2>
                <h3>Student Progress Report</h3>
                <p>Student: ${student?.name} (${admission}) | Class: ${student?.class}</p>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Exam</th>
                        <th>Subject</th>
                        <th>Score</th>
                        <th>Grade</th>
                        <th>Remarks</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        studentResults.sort((a, b) => b.score - a.score).forEach(r => {
            const exam = exams.find(e => e.id === r.examId);
            let remark = 'Good';
            if (r.score >= 80) remark = 'Excellent';
            else if (r.score >= 70) remark = 'Very Good';
            else if (r.score >= 60) remark = 'Good';
            else if (r.score >= 50) remark = 'Average';
            else remark = 'Needs Improvement';
            
            html += `
                <tr>
                    <td>${exam?.name || 'N/A'}</td>
                    <td>${r.subject}</td>
                    <td>${r.score}%</td>
                    <td class="grade-${r.grade.toLowerCase()}">${r.grade}</td>
                    <td>${remark}</td>
                </tr>
            `;
        });
        
        const avgScore = studentResults.reduce((sum, r) => sum + r.score, 0) / studentResults.length || 0;
        const position = calculateStudentPosition(admission);
        
        html += `
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="5" style="text-align: right;">
                            <strong>Average Score: ${avgScore.toFixed(1)}% | Grade: ${calculateGrade(avgScore)} | Position: ${position}</strong>
                        </td>
                    </tr>
                </tfoot>
            </table>
        `;
        
        return html;
    }
    
    function calculateStudentPosition(admission) {
        const student = students.find(s => s.admission === admission);
        if (!student) return 'N/A';
        
        const classResults = examResults.filter(r => r.class === student.class);
        const studentResults = classResults.filter(r => r.admission === admission);
        if (studentResults.length === 0) return 'N/A';
        
        const studentAvg = studentResults.reduce((sum, r) => sum + r.score, 0) / studentResults.length;
        
        const avgs = {};
        classResults.forEach(r => {
            if (!avgs[r.admission]) {
                avgs[r.admission] = { total: 0, count: 0 };
            }
            avgs[r.admission].total += r.score;
            avgs[r.admission].count++;
        });
        
        const averages = Object.entries(avgs).map(([adm, data]) => ({
            admission: adm,
            avg: data.total / data.count
        })).sort((a, b) => b.avg - a.avg);
        
        const position = averages.findIndex(a => a.admission === admission) + 1;
        return `${position} / ${averages.length}`;
    }
    
    function printStudentReport() {
        window.print();
    }
    
    async function emailStudentReport() {
        const admission = document.querySelector('#studentReportContent').innerHTML.match(/Student: (.*?) \(/)?.[1];
        if (admission) {
            const student = students.find(s => s.admission === admission);
            if (student?.parentEmail) {
                const subject = `Progress Report for ${student.name}`;
                const message = generateStudentReportHTML(admission).replace(/<[^>]*>/g, ' ');
                
                const sent = await sendEmailJS(student.parentEmail, subject, message);
                
                if (sent) {
                    alert(`‚úÖ Report emailed to ${student.parentEmail}`);
                    logActivity(`Emailed report to ${student.parentEmail}`);
                    showNotification('‚úÖ Report emailed!');
                }
            } else {
                alert('Parent email not available');
            }
        }
    }
    
    function showDeleteExamResult(id) {
        const result = examResults.find(r => r.id === id);
        if (!result) return;
        
        const student = students.find(s => s.admission === result.admission);
        document.getElementById('deleteResultInfo').innerText = `Student: ${student?.name || 'N/A'}, Score: ${result.score}%`;
        document.getElementById('deleteResultId').value = id;
        document.getElementById('deleteExamResultModal').style.display = 'flex';
    }
    
    function confirmDeleteExamResult() {
        const id = document.getElementById('deleteResultId').value;
        examResults = examResults.filter(r => r.id !== id);
        localStorage.setItem('examResults', JSON.stringify(examResults));
        loadExamResults();
        closeModal('deleteExamResultModal');
        logActivity('Deleted exam result');
        showNotification('‚úÖ Exam result deleted');
    }
    
    // ========== FEE MANAGEMENT ==========
    function loadFees() {
        const tbody = document.getElementById('feesList');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        fees.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(fee => {
            const student = students.find(s => s.admission === fee.admission);
            const balance = calculateStudentBalance(fee.admission);
            
            tbody.innerHTML += `
                <tr>
                    <td>${new Date(fee.date).toLocaleDateString()}</td>
                    <td>${fee.receipt}</td>
                    <td>${fee.admission}</td>
                    <td>${student?.name || 'N/A'}</td>
                    <td>${fee.class}</td>
                    <td>Term ${fee.term}</td>
                    <td>KSh ${fee.amount.toLocaleString()}</td>
                    <td>KSh ${balance.toLocaleString()}</td>
                    <td>${fee.mode}</td>
                    <td>
                        <button class="btn btn-danger" style="padding: 5px;" onclick="deleteFee('${fee.receipt}')">üóëÔ∏è</button>
                    </td>
                </tr>
            `;
        });
        
        updateFeeStats();
    }
    
    function loadFeeStructureList() {
        const tbody = document.getElementById('feeStructureList');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        Object.keys(feeStructure).forEach(className => {
            Object.keys(feeStructure[className]).forEach(term => {
                const fees = feeStructure[className][term];
                const total = (fees.tuition || 0) + (fees.transport || 0) + (fees.boarding || 0) + (fees.activities || 0);
                tbody.innerHTML += `
                    <tr>
                        <td>${className}</td>
                        <td>Term ${term}</td>
                        <td>KSh ${(fees.tuition || 0).toLocaleString()}</td>
                        <td>KSh ${(fees.transport || 0).toLocaleString()}</td>
                        <td>KSh ${(fees.boarding || 0).toLocaleString()}</td>
                        <td>KSh ${(fees.activities || 0).toLocaleString()}</td>
                        <td>KSh ${total.toLocaleString()}</td>
                        <td>
                            <button class="btn btn-warning" style="padding: 5px;" onclick="editFeeStructure('${className}', '${term}')">‚úèÔ∏è</button>
                        </td>
                    </tr>
                `;
            });
        });
    }
    
    function updateFeeStats() {
        let totalExpected = 0;
        let totalPaid = 0;
        
        students.forEach(student => {
            const expected = getExpectedFee(student.class, student.route);
            totalExpected += expected;
            
            const paid = fees
                .filter(f => f.admission === student.admission && f.term === settings.currentTerm)
                .reduce((sum, f) => sum + f.amount, 0);
            totalPaid += paid;
        });
        
        const outstanding = totalExpected - totalPaid;
        const rate = totalExpected > 0 ? ((totalPaid / totalExpected) * 100).toFixed(1) : 0;
        
        document.getElementById('totalExpected').innerText = 'KSh ' + totalExpected.toLocaleString();
        document.getElementById('totalPaid').innerText = 'KSh ' + totalPaid.toLocaleString();
        document.getElementById('totalOutstanding').innerText = 'KSh ' + outstanding.toLocaleString();
        document.getElementById('collectionRate').innerText = rate + '%';
        document.getElementById('feeTerm').innerText = settings.currentTerm;
        document.getElementById('feeYear').innerText = settings.academicYear;
    }
    
    function getExpectedFee(className, route) {
        const structure = feeStructure[className]?.[settings.currentTerm];
        if (!structure) return 0;
        
        let total = structure.tuition || 0;
        if (route !== 'Boarder') {
            total += structure.transport || 0;
        } else {
            total += structure.boarding || 0;
        }
        total += structure.activities || 0;
        
        return total;
    }
    
    function calculateStudentBalance(admission) {
        const student = students.find(s => s.admission === admission);
        if (!student) return 0;
        
        const expected = getExpectedFee(student.class, student.route);
        const paid = fees
            .filter(f => f.admission === admission && f.term === settings.currentTerm)
            .reduce((sum, f) => sum + f.amount, 0);
        
        return expected - paid;
    }
    
    function showRecordFeeModal() {
        generateReceiptNumber();
        document.getElementById('feeAdmission').value = '';
        document.getElementById('feeStudentName').value = '';
        document.getElementById('feeClass').value = '';
        document.getElementById('feeAmount').value = '';
        document.getElementById('feeSearchStudent').value = '';
        document.getElementById('feeStudentList').innerHTML = '';
        document.getElementById('feeStudentList').style.display = 'none';
        document.getElementById('feeModal').style.display = 'flex';
    }
    
    function generateReceiptNumber() {
        const date = new Date();
        const year = date.getFullYear();
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const day = date.getDate().toString().padStart(2, '0');
        const count = fees.length + 1;
        const receipt = `RCP${year}${month}${day}${count.toString().padStart(4, '0')}`;
        document.getElementById('feeReceipt').value = receipt;
    }
    
    function searchFeeStudent() {
        const search = document.getElementById('feeSearchStudent').value.toUpperCase();
        if (search.length < 2) {
            document.getElementById('feeStudentList').style.display = 'none';
            return;
        }
        
        const matches = students.filter(s => 
            s.name.toUpperCase().includes(search) || 
            s.admission.toUpperCase().includes(search)
        );
        
        const listDiv = document.getElementById('feeStudentList');
        listDiv.innerHTML = '';
        
        if (matches.length > 0) {
            matches.forEach(student => {
                const div = document.createElement('div');
                div.className = 'student-search-item';
                div.innerText = `${student.admission} - ${student.name} (${student.class})`;
                div.onclick = () => selectFeeStudent(student);
                listDiv.appendChild(div);
            });
            listDiv.style.display = 'block';
        } else {
            listDiv.style.display = 'none';
        }
    }
    
    function selectFeeStudent(student) {
        document.getElementById('feeAdmission').value = student.admission;
        document.getElementById('feeStudentName').value = student.name;
        document.getElementById('feeClass').value = student.class;
        document.getElementById('feeStudentList').style.display = 'none';
        
        const balance = calculateStudentBalance(student.admission);
        if (balance > 0) {
            document.getElementById('feeAmount').value = balance;
        }
    }
    
    function quickFeePayment(admission) {
        const student = students.find(s => s.admission === admission);
        if (student) {
            selectFeeStudent(student);
            document.getElementById('feeModal').style.display = 'flex';
        }
    }
    
    function recordFeePayment() {
        const admission = document.getElementById('feeAdmission').value;
        const amount = parseInt(document.getElementById('feeAmount').value);
        const mode = document.getElementById('feeMode').value;
        const receipt = document.getElementById('feeReceipt').value;
        const term = document.getElementById('feeTermSelect').value;
        
        if (!admission || !amount || amount <= 0) {
            alert('‚ùå Please select a student and enter valid amount');
            return;
        }
        
        const student = students.find(s => s.admission === admission);
        
        const fee = {
            receipt: receipt,
            date: new Date().toISOString(),
            admission: admission,
            class: student.class,
            term: term,
            amount: amount,
            mode: mode
        };
        
        fees.push(fee);
        localStorage.setItem('fees', JSON.stringify(fees));
        loadFees();
        loadStudents();
        closeModal('feeModal');
        logActivity(`Recorded payment of KSh ${amount} from ${student.name}`);
        showNotification('‚úÖ Fee payment recorded!');
    }
    
    function deleteFee(receipt) {
        if (confirm('‚ö†Ô∏è Delete this fee record?')) {
            fees = fees.filter(f => f.receipt !== receipt);
            localStorage.setItem('fees', JSON.stringify(fees));
            loadFees();
            loadStudents();
            showNotification('‚úÖ Fee record deleted');
        }
    }
    
    function filterFees() {
        const search = document.getElementById('searchFees').value.toUpperCase();
        document.querySelectorAll('#feesList tr').forEach(tr => {
            const text = tr.innerText.toUpperCase();
            tr.style.display = text.includes(search) ? '' : 'none';
        });
    }
    
    function showFeeStructureModal() {
        document.getElementById('feeStructureClass').value = '';
        document.getElementById('feeStructureTerm').value = settings.currentTerm;
        document.getElementById('feeTuition').value = 0;
        document.getElementById('feeTransport').value = 0;
        document.getElementById('feeBoarding').value = 0;
        document.getElementById('feeActivities').value = 0;
        updateFeeTotal();
        document.getElementById('feeStructureModal').style.display = 'flex';
    }
    
    function updateFeeTotal() {
        const tuition = parseInt(document.getElementById('feeTuition').value) || 0;
        const transport = parseInt(document.getElementById('feeTransport').value) || 0;
        const boarding = parseInt(document.getElementById('feeBoarding').value) || 0;
        const activities = parseInt(document.getElementById('feeActivities').value) || 0;
        const total = tuition + transport + boarding + activities;
        document.getElementById('feeTotal').value = total;
    }
    
    function saveFeeStructure() {
        const className = document.getElementById('feeStructureClass').value;
        const term = document.getElementById('feeStructureTerm').value;
        
        if (!className) {
            alert('‚ùå Please select a class');
            return;
        }
        
        if (!feeStructure[className]) {
            feeStructure[className] = {};
        }
        
        feeStructure[className][term] = {
            tuition: parseInt(document.getElementById('feeTuition').value) || 0,
            transport: parseInt(document.getElementById('feeTransport').value) || 0,
            boarding: parseInt(document.getElementById('feeBoarding').value) || 0,
            activities: parseInt(document.getElementById('feeActivities').value) || 0
        };
        
        localStorage.setItem('feeStructure', JSON.stringify(feeStructure));
        loadFeeStructureList();
        updateFeeStats();
        closeModal('feeStructureModal');
        logActivity(`Updated fee structure for ${className}`);
        showNotification('‚úÖ Fee structure saved!');
    }
    
    function editFeeStructure(className, term) {
        const fees = feeStructure[className]?.[term];
        if (fees) {
            document.getElementById('feeStructureClass').value = className;
            document.getElementById('feeStructureTerm').value = term;
            document.getElementById('feeTuition').value = fees.tuition || 0;
            document.getElementById('feeTransport').value = fees.transport || 0;
            document.getElementById('feeBoarding').value = fees.boarding || 0;
            document.getElementById('feeActivities').value = fees.activities || 0;
            updateFeeTotal();
            document.getElementById('feeStructureModal').style.display = 'flex';
        }
    }
    
    function setTotalExpectedFee() {
        document.getElementById('totalFeeClass').value = '';
        document.getElementById('totalFeeAmount').value = '';
        document.getElementById('totalFeeTerm').value = settings.currentTerm;
        document.getElementById('totalExpectedFeeModal').style.display = 'flex';
    }
    
    function saveTotalExpectedFee() {
        const className = document.getElementById('totalFeeClass').value;
        const amount = parseInt(document.getElementById('totalFeeAmount').value);
        const term = document.getElementById('totalFeeTerm').value;
        
        if (!className || !amount || amount <= 0) {
            alert('‚ùå Please select a class and enter valid amount');
            return;
        }
        
        if (!feeStructure[className]) {
            feeStructure[className] = {};
        }
        
        feeStructure[className][term] = {
            tuition: amount,
            transport: 0,
            boarding: 0,
            activities: 0
        };
        
        localStorage.setItem('feeStructure', JSON.stringify(feeStructure));
        loadFeeStructureList();
        updateFeeStats();
        closeModal('totalExpectedFeeModal');
        logActivity(`Set total expected fee for ${className} to KSh ${amount}`);
        showNotification('‚úÖ Total expected fee set successfully!');
    }
    
    function trackIndividualFee() {
        document.getElementById('individualFeeSearch').value = '';
        document.getElementById('individualFeeStudentList').innerHTML = '';
        document.getElementById('individualFeeDetails').innerHTML = '';
        document.getElementById('individualFeeModal').style.display = 'flex';
    }
    
    function searchIndividualFeeStudent() {
        const search = document.getElementById('individualFeeSearch').value.toLowerCase();
        if (search.length < 2) {
            document.getElementById('individualFeeStudentList').innerHTML = '';
            return;
        }
        
        const matches = students.filter(s => 
            s.name.toLowerCase().includes(search) || 
            s.admission.toLowerCase().includes(search)
        );
        
        const listDiv = document.getElementById('individualFeeStudentList');
        listDiv.innerHTML = '<h4>Select Student:</h4>';
        
        matches.forEach(student => {
            const div = document.createElement('div');
            div.className = 'student-search-item';
            div.innerHTML = `${student.admission} - ${student.name} (${student.class})`;
            div.onclick = () => showIndividualFeeDetails(student);
            listDiv.appendChild(div);
        });
    }
    
    function showIndividualFeeDetails(student) {
        const balance = calculateStudentBalance(student.admission);
        const studentFees = fees.filter(f => f.admission === student.admission && f.term === settings.currentTerm);
        const expected = getExpectedFee(student.class, student.route);
        
        let html = `
            <h4>Fee Details for ${student.name}</h4>
            <p>Admission: ${student.admission} | Class: ${student.class}</p>
            <p>Expected Fee: KSh ${expected.toLocaleString()}</p>
            <p>Total Paid: KSh ${studentFees.reduce((sum, f) => sum + f.amount, 0).toLocaleString()}</p>
            <p>Balance: KSh ${balance.toLocaleString()}</p>
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Receipt</th>
                        <th>Amount</th>
                        <th>Mode</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        studentFees.forEach(f => {
            html += `
                <tr>
                    <td>${new Date(f.date).toLocaleDateString()}</td>
                    <td>${f.receipt}</td>
                    <td>KSh ${f.amount.toLocaleString()}</td>
                    <td>${f.mode}</td>
                </tr>
            `;
        });
        
        html += `</tbody></table>`;
        document.getElementById('individualFeeDetails').innerHTML = html;
    }
    
    function searchFeeStudentRecords() {
        const search = document.getElementById('searchFees').value.toLowerCase();
        if (search.length < 2) {
            document.getElementById('feeStudentSearchResults').innerHTML = '';
            return;
        }
        
        const matches = students.filter(s => 
            s.name.toLowerCase().includes(search) || 
            s.admission.toLowerCase().includes(search)
        );
        
        const resultsDiv = document.getElementById('feeStudentSearchResults');
        resultsDiv.innerHTML = '<h4>Student Fee Records</h4>';
        
        matches.forEach(student => {
            const balance = calculateStudentBalance(student.admission);
            const div = document.createElement('div');
            div.className = 'student-search-item';
            div.innerHTML = `
                <strong>${student.name}</strong> (${student.admission}) - ${student.class}<br>
                Balance: KSh ${balance.toLocaleString()}
            `;
            div.onclick = () => showIndividualFeeDetails(student);
            resultsDiv.appendChild(div);
        });
    }
    
    // ========== TRIP MANAGEMENT ==========
    function loadTrips() {
        const tbody = document.getElementById('tripsList');
        if (!tbody) return;
        
        let upcoming = 0, past = 0, totalStudents = 0;
        tbody.innerHTML = '';
        trips.sort((a, b) => new Date(a.date) - new Date(b.date)).forEach(trip => {
            const tripDate = new Date(trip.date);
            const today = new Date();
            const status = tripDate >= today ? 'Upcoming' : 'Past';
            if (status === 'Upcoming') upcoming++;
            else past++;
            
            const tripPaymentsList = tripPayments.filter(p => p.tripId === trip.id);
            const paidCount = tripPaymentsList.length;
            
            tbody.innerHTML += `
                <tr>
                    <td>${trip.destination}</td>
                    <td>${tripDate.toLocaleDateString()}</td>
                    <td>${trip.departure}</td>
                    <td>${trip.return}</td>
                    <td>${trip.classes}</td>
                    <td>${trip.teacherName || 'N/A'}</td>
                    <td>${trip.students} (${paidCount} paid)</td>
                    <td>KSh ${trip.cost}</td>
                    <td><span class="badge ${status === 'Upcoming' ? 'badge-success' : 'badge-secondary'}">${status}</span></td>
                    <td>
                        <button class="btn btn-primary" style="padding: 5px;" onclick="viewTrip('${trip.id}')">üëÅÔ∏è</button>
                        <button class="btn btn-success" style="padding: 5px;" onclick="showTripPaymentModal('${trip.id}')">üí∞</button>
                        <button class="btn btn-danger" style="padding: 5px;" onclick="deleteTrip('${trip.id}')">üóëÔ∏è</button>
                    </td>
                </tr>
            `;
        });
        
        document.getElementById('totalTrips').innerText = trips.length;
        document.getElementById('upcomingTrips').innerText = upcoming;
        document.getElementById('pastTrips').innerText = past;
        
        loadTripPayments();
    }
    
    function loadTripPayments() {
        const container = document.getElementById('tripPaymentsContainer');
        if (!container) return;
        
        if (tripPayments.length === 0) {
            container.innerHTML = '<h4>üí∞ Trip Payments</h4><p>No payments recorded yet.</p>';
            return;
        }
        
        let html = '<h4>üí∞ Trip Payment Records</h4>';
        
        tripPayments.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(payment => {
            const trip = trips.find(t => t.id === payment.tripId);
            const student = students.find(s => s.admission === payment.studentAdmission);
            
            html += `
                <div class="payment-item">
                    <div>
                        <strong>${trip?.destination || 'Unknown Trip'}</strong> - 
                        ${student?.name || 'Unknown Student'} (${payment.studentAdmission})<br>
                        Paid: KSh ${payment.amount} on ${new Date(payment.date).toLocaleDateString()}
                    </div>
                    <button class="btn btn-danger btn-small" onclick="deleteTripPayment('${payment.id}')">üóëÔ∏è Remove</button>
                </div>
            `;
        });
        
        container.innerHTML = html;
    }
    
    function showAddTripModal() {
        document.getElementById('tripDestination').value = '';
        document.getElementById('tripDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('tripDeparture').value = '08:00';
        document.getElementById('tripReturn').value = '16:00';
        document.getElementById('tripClasses').selectedIndex = -1;
        document.getElementById('tripCost').value = 0;
        document.getElementById('tripNotes').value = '';
        document.getElementById('tripModal').style.display = 'flex';
    }
    
    function saveTrip() {
        const destination = document.getElementById('tripDestination').value.trim();
        const date = document.getElementById('tripDate').value;
        
        if (!destination || !date) {
            alert('‚ùå Please fill destination and date');
            return;
        }
        
        const selectedClasses = Array.from(document.getElementById('tripClasses').selectedOptions).map(o => o.value);
        const teacherTSC = document.getElementById('tripTeacher').value;
        const teacher = teachers.find(t => t.tsc === teacherTSC);
        
        const trip = {
            id: Date.now().toString(),
            destination: destination,
            date: date,
            departure: document.getElementById('tripDeparture').value,
            return: document.getElementById('tripReturn').value,
            classes: selectedClasses.join(', '),
            teacherTSC: teacherTSC,
            teacherName: teacher?.name || '',
            students: 0, // Will be updated as payments come in
            cost: parseInt(document.getElementById('tripCost').value) || 0,
            notes: document.getElementById('tripNotes').value.trim()
        };
        
        trips.push(trip);
        localStorage.setItem('trips', JSON.stringify(trips));
        loadTrips();
        closeModal('tripModal');
        logActivity(`Scheduled trip to ${destination}`);
        showNotification('‚úÖ Trip scheduled!');
    }
    
    function showTripPaymentModal(tripId = null) {
        const tripSelect = document.getElementById('paymentTripSelect');
        tripSelect.innerHTML = '<option value="">Select Trip</option>';
        
        trips.forEach(trip => {
            const option = document.createElement('option');
            option.value = trip.id;
            option.textContent = `${trip.destination} (${new Date(trip.date).toLocaleDateString()})`;
            tripSelect.appendChild(option);
        });
        
        if (tripId) {
            tripSelect.value = tripId;
        }
        
        document.getElementById('paymentStudentSearch').value = '';
        document.getElementById('paymentStudentList').innerHTML = '';
        document.getElementById('paymentStudentList').style.display = 'none';
        document.getElementById('paymentStudentName').value = '';
        document.getElementById('paymentStudentAdmission').value = '';
        document.getElementById('paymentAmount').value = '';
        
        document.getElementById('tripPaymentModal').style.display = 'flex';
    }
    
    function searchPaymentStudent() {
        const search = document.getElementById('paymentStudentSearch').value.toLowerCase();
        if (search.length < 2) {
            document.getElementById('paymentStudentList').style.display = 'none';
            return;
        }
        
        const matches = students.filter(s => 
            s.name.toLowerCase().includes(search) || 
            s.admission.toLowerCase().includes(search)
        );
        
        const listDiv = document.getElementById('paymentStudentList');
        listDiv.innerHTML = '';
        
        if (matches.length > 0) {
            matches.forEach(student => {
                const div = document.createElement('div');
                div.className = 'student-search-item';
                div.innerText = `${student.admission} - ${student.name} (${student.class})`;
                div.onclick = () => selectPaymentStudent(student);
                listDiv.appendChild(div);
            });
            listDiv.style.display = 'block';
        } else {
            listDiv.style.display = 'none';
        }
    }
    
    function selectPaymentStudent(student) {
        document.getElementById('paymentStudentName').value = student.name;
        document.getElementById('paymentStudentAdmission').value = student.admission;
        document.getElementById('paymentStudentList').style.display = 'none';
        
        const tripId = document.getElementById('paymentTripSelect').value;
        const trip = trips.find(t => t.id === tripId);
        if (trip) {
            document.getElementById('paymentAmount').value = trip.cost;
        }
    }
    
    function recordTripPayment() {
        const tripId = document.getElementById('paymentTripSelect').value;
        const studentAdmission = document.getElementById('paymentStudentAdmission').value;
        const amount = parseInt(document.getElementById('paymentAmount').value);
        
        if (!tripId || !studentAdmission || !amount) {
            alert('‚ùå Please select trip, student and enter amount');
            return;
        }
        
        const payment = {
            id: Date.now().toString(),
            tripId: tripId,
            studentAdmission: studentAdmission,
            amount: amount,
            date: new Date().toISOString()
        };
        
        tripPayments.push(payment);
        localStorage.setItem('tripPayments', JSON.stringify(tripPayments));
        
        // Update trip student count
        const trip = trips.find(t => t.id === tripId);
        if (trip) {
            const paidCount = tripPayments.filter(p => p.tripId === tripId).length;
            trip.students = paidCount;
            localStorage.setItem('trips', JSON.stringify(trips));
        }
        
        loadTrips();
        closeModal('tripPaymentModal');
        logActivity(`Recorded trip payment for student ${studentAdmission}`);
        showNotification('‚úÖ Trip payment recorded!');
    }
    
    function deleteTripPayment(paymentId) {
        if (confirm('Remove this payment record?')) {
            tripPayments = tripPayments.filter(p => p.id !== paymentId);
            localStorage.setItem('tripPayments', JSON.stringify(tripPayments));
            
            // Update trip student counts
            trips.forEach(trip => {
                const paidCount = tripPayments.filter(p => p.tripId === trip.id).length;
                trip.students = paidCount;
            });
            localStorage.setItem('trips', JSON.stringify(trips));
            
            loadTrips();
            showNotification('‚úÖ Payment record removed');
        }
    }
    
    function filterTrips() {
        const search = document.getElementById('searchTrips').value.toUpperCase();
        document.querySelectorAll('#tripsList tr').forEach(tr => {
            const text = tr.innerText.toUpperCase();
            tr.style.display = text.includes(search) ? '' : 'none';
        });
    }
    
    function deleteTrip(id) {
        if (confirm('‚ö†Ô∏è Delete this trip? This will also delete all payment records for this trip.')) {
            trips = trips.filter(t => t.id !== id);
            tripPayments = tripPayments.filter(p => p.tripId !== id);
            localStorage.setItem('trips', JSON.stringify(trips));
            localStorage.setItem('tripPayments', JSON.stringify(tripPayments));
            loadTrips();
            showNotification('‚úÖ Trip deleted');
        }
    }
    
    function viewTrip(id) {
        const trip = trips.find(t => t.id === id);
        if (trip) {
            const payments = tripPayments.filter(p => p.tripId === id);
            const paidStudents = payments.map(p => {
                const student = students.find(s => s.admission === p.studentAdmission);
                return student ? `${student.name} (${student.admission})` : p.studentAdmission;
            }).join('\n');
            
            alert(`
üöå Trip Details
Destination: ${trip.destination}
Date: ${new Date(trip.date).toLocaleDateString()}
Time: ${trip.departure} - ${trip.return}
Classes: ${trip.classes}
Teacher: ${trip.teacherName}
Students: ${payments.length} paid
Cost per student: KSh ${trip.cost}
Total Collected: KSh ${(trip.cost * payments.length).toLocaleString()}
Notes: ${trip.notes || 'None'}

Paid Students:
${paidStudents || 'None'}
            `);
        }
    }
    
    // ========== CLASS FUNCTIONS ==========
    function viewClassDetails(className) {
        const classStudents = students.filter(s => s.class === className);
        const row = document.querySelector(`tr[data-class="${className}"]`);
        const absent = row?.querySelector('.c-names')?.innerText || '-';
        const boys = row?.querySelector('.c-b')?.innerText || '0';
        const girls = row?.querySelector('.c-g')?.innerText || '0';
        const total = row?.querySelector('.c-t')?.innerText || '0';
        const absentCount = row?.querySelector('.c-a')?.innerText || '0';
        
        alert(`
üìã CLASS: ${className}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üë¶ Boys: ${boys}
üëß Girls: ${girls}
üìä Total: ${total}
‚ùå Absent: ${absentCount}

üìù ABSENTEES:
${absent}

üë• Registered Students: ${classStudents.length}
        `);
    }
    
    function editClass(className) {
        const row = document.querySelector(`tr[data-class="${className}"]`);
        if (!row) return;
        
        const boys = prompt('Enter Boys count:', row.querySelector('.c-b').innerText);
        if (boys === null) return;
        
        const girls = prompt('Enter Girls count:', row.querySelector('.c-g').innerText);
        if (girls === null) return;
        
        const total = parseInt(boys) + parseInt(girls);
        const lunch = prompt('Enter Lunch count:', row.querySelector('.c-l').innerText);
        if (lunch === null) return;
        
        const newStudents = prompt('Enter New students:', row.querySelector('.c-n').innerText);
        if (newStudents === null) return;
        
        const nr = prompt('Enter N.R. count:', row.querySelector('.c-nr').innerText);
        if (nr === null) return;
        
        const absent = prompt('Enter Absent count:', row.querySelector('.c-a').innerText);
        if (absent === null) return;
        
        const names = prompt('Enter Absentee names (comma separated):', row.querySelector('.c-names').innerText);
        if (names === null) return;
        
        const nameCount = names === "-" ? 0 : names.split(',').length;
        
        row.querySelector('.c-b').innerText = boys || '0';
        row.querySelector('.c-g').innerText = girls || '0';
        row.querySelector('.c-t').innerText = total;
        row.querySelector('.c-l').innerText = lunch || '0';
        row.querySelector('.c-n').innerText = newStudents || '0';
        row.querySelector('.c-nr').innerText = nr || '0';
        row.querySelector('.c-a').innerText = nameCount;
        row.querySelector('.c-names').innerText = names || '-';
        
        saveToHistory(className, {
            date: new Date().toISOString(),
            boys: parseInt(boys) || 0,
            girls: parseInt(girls) || 0,
            total: total,
            absent: nameCount
        });
        
        calculateTotals();
        updateStatistics();
        logActivity(`Updated attendance for ${className}`);
        showNotification(`‚úÖ ${className} updated`);
    }
    
    function clearClass(className) {
        if (confirm(`‚ö†Ô∏è Clear all data for ${className}?`)) {
            const row = document.querySelector(`tr[data-class="${className}"]`);
            if (row) {
                row.querySelector('.c-b').innerText = '0';
                row.querySelector('.c-g').innerText = '0';
                row.querySelector('.c-t').innerText = '0';
                row.querySelector('.c-l').innerText = '0';
                row.querySelector('.c-n').innerText = '0';
                row.querySelector('.c-nr').innerText = '0';
                row.querySelector('.c-a').innerText = '0';
                row.querySelector('.c-names').innerText = '-';
                
                calculateTotals();
                updateStatistics();
                showNotification(`‚úÖ ${className} cleared`);
            }
        }
    }
    
    // ========== ANALYTICS ==========
    function updateAnalytics() {
        const type = document.getElementById('analyticsType').value;
        const period = document.getElementById('analyticsPeriod').value;
        
        let data = [];
        let labels = [];
        let statsHtml = '';
        
        if (type === 'attendance') {
            const filtered = filterByPeriod(attendanceHistory, period);
            const dailyAvg = {};
            
            filtered.forEach(h => {
                const date = h.date.split('T')[0];
                if (!dailyAvg[date]) {
                    dailyAvg[date] = { total: 0, present: 0, count: 0 };
                }
                dailyAvg[date].total += h.total || 0;
                dailyAvg[date].present += (h.total || 0) - (h.absent || 0);
                dailyAvg[date].count++;
            });
            
            labels = Object.keys(dailyAvg).sort();
            data = labels.map(d => {
                const day = dailyAvg[d];
                return day.total > 0 ? ((day.present / day.total) * 100).toFixed(1) : 0;
            });
            
            const avgAttendance = data.reduce((sum, val) => sum + parseFloat(val), 0) / data.length || 0;
            statsHtml = `
                <div class="stat-card">
                    <div class="stat-label">Avg Attendance</div>
                    <div class="stat-number">${avgAttendance.toFixed(1)}%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Days Recorded</div>
                    <div class="stat-number">${labels.length}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Best Day</div>
                    <div class="stat-number">${Math.max(...data.map(parseFloat)).toFixed(1)}%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Worst Day</div>
                    <div class="stat-number">${Math.min(...data.map(parseFloat)).toFixed(1)}%</div>
                </div>
            `;
        } else if (type === 'students') {
            const classCount = {};
            students.forEach(s => {
                classCount[s.class] = (classCount[s.class] || 0) + 1;
            });
            
            labels = Object.keys(classCount).sort();
            data = labels.map(c => classCount[c]);
            
            statsHtml = `
                <div class="stat-card">
                    <div class="stat-label">Total Students</div>
                    <div class="stat-number">${students.length}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Boys</div>
                    <div class="stat-number">${students.filter(s => s.gender === 'Boy').length}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Girls</div>
                    <div class="stat-number">${students.filter(s => s.gender === 'Girl').length}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Classes</div>
                    <div class="stat-number">${Object.keys(classCount).length}</div>
                </div>
            `;
        } else if (type === 'exams') {
            const examScores = {};
            examResults.forEach(r => {
                const exam = exams.find(e => e.id === r.examId);
                if (exam) {
                    const key = `${exam.name} (Term ${exam.term})`;
                    if (!examScores[key]) {
                        examScores[key] = { total: 0, count: 0 };
                    }
                    examScores[key].total += r.score;
                    examScores[key].count++;
                }
            });
            
            labels = Object.keys(examScores);
            data = labels.map(l => (examScores[l].total / examScores[l].count).toFixed(1));
            
            statsHtml = `
                <div class="stat-card">
                    <div class="stat-label">Total Exams</div>
                    <div class="stat-number">${exams.length}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Results Entered</div>
                    <div class="stat-number">${examResults.length}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Avg Score</div>
                    <div class="stat-number">${(examResults.reduce((sum, r) => sum + r.score, 0) / examResults.length || 0).toFixed(1)}%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Top Grade</div>
                    <div class="stat-number">${examResults.length > 0 ? calculateGrade(Math.max(...examResults.map(r => r.score))) : '-'}</div>
                </div>
            `;
        } else if (type === 'fees') {
            const paidByClass = {};
            students.forEach(s => {
                if (!paidByClass[s.class]) {
                    paidByClass[s.class] = { paid: 0, expected: 0 };
                }
                paidByClass[s.class].expected += getExpectedFee(s.class, s.route);
            });
            
            fees.filter(f => f.term === settings.currentTerm).forEach(f => {
                if (paidByClass[f.class]) {
                    paidByClass[f.class].paid += f.amount;
                }
            });
            
            labels = Object.keys(paidByClass).sort();
            data = labels.map(c => (paidByClass[c].paid / paidByClass[c].expected * 100).toFixed(1) || 0);
            
            const totalExpected = Object.values(paidByClass).reduce((sum, c) => sum + c.expected, 0);
            const totalPaid = Object.values(paidByClass).reduce((sum, c) => sum + c.paid, 0);
            
            statsHtml = `
                <div class="stat-card">
                    <div class="stat-label">Collection Rate</div>
                    <div class="stat-number">${((totalPaid / totalExpected) * 100 || 0).toFixed(1)}%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Paid</div>
                    <div class="stat-number">KSh ${totalPaid.toLocaleString()}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Outstanding</div>
                    <div class="stat-number">KSh ${(totalExpected - totalPaid).toLocaleString()}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Best Paying Class</div>
                    <div class="stat-number">${Object.keys(paidByClass).reduce((a, b) => 
                        (paidByClass[a].paid / paidByClass[a].expected) > (paidByClass[b].paid / paidByClass[b].expected) ? a : b
                    )}</div>
                </div>
            `;
        }
        
        document.getElementById('analyticsStats').innerHTML = statsHtml;
        
        const ctx = document.getElementById('analyticsChart').getContext('2d');
        
        if (chart) {
            chart.destroy();
        }
        
        chart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: type.charAt(0).toUpperCase() + type.slice(1),
                    data: data,
                    backgroundColor: 'rgba(52, 152, 219, 0.5)',
                    borderColor: '#3498db',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
    
    function filterByPeriod(data, period) {
        const now = new Date();
        let cutoff = new Date();
        
        if (period === 'weekly') {
            cutoff.setDate(now.getDate() - 7);
        } else if (period === 'monthly') {
            cutoff.setMonth(now.getMonth() - 1);
        } else if (period === 'termly') {
            cutoff.setMonth(now.getMonth() - 3);
        } else if (period === 'yearly') {
            cutoff.setFullYear(now.getFullYear() - 1);
        }
        
        return data.filter(d => new Date(d.date) >= cutoff);
    }
    
    function exportAnalytics() {
        if (!chart) {
            alert('Please generate analytics first');
            return;
        }
        
        const data = {
            labels: chart.data.labels,
            datasets: chart.data.datasets
        };
        
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `analytics_${new Date().toISOString()}.json`;
        a.click();
        showNotification('üìä Analytics exported');
    }
    
    // ========== REPORTS ==========
    function generateReport() {
        const type = document.getElementById('reportType').value;
        const startDate = document.getElementById('reportStartDate').value;
        const endDate = document.getElementById('reportEndDate').value;
        const className = document.getElementById('reportClass').value;
        
        let html = '';
        
        if (type === 'rollcall') {
            html = generateRollCallReport(startDate, endDate);
        } else if (type === 'students') {
            html = generateStudentReport(className);
        } else if (type === 'teachers') {
            html = generateTeacherReport();
        } else if (type === 'exams') {
            html = generateExamReport(startDate, endDate, className);
        } else if (type === 'fees') {
            html = generateFeeReport(className);
        } else if (type === 'trips') {
            html = generateTripReport(startDate, endDate);
        }
        
        document.getElementById('reportOutput').innerHTML = html;
    }
    
    function generateRollCallReport(startDate, endDate) {
        let filtered = attendanceHistory;
        if (startDate) {
            filtered = filtered.filter(h => h.date.split('T')[0] >= startDate);
        }
        if (endDate) {
            filtered = filtered.filter(h => h.date.split('T')[0] <= endDate);
        }
        
        const dailyStats = {};
        filtered.forEach(h => {
            const date = h.date.split('T')[0];
            if (!dailyStats[date]) {
                dailyStats[date] = { total: 0, present: 0, count: 0 };
            }
            dailyStats[date].total += h.total || 0;
            dailyStats[date].present += (h.total || 0) - (h.absent || 0);
            dailyStats[date].count++;
        });
        
        let html = `
            <div class="report-header">
                <h3>üìã Roll Call Report</h3>
                <p>Period: ${startDate || 'All'} to ${endDate || 'All'}</p>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Total Students</th>
                        <th>Present</th>
                        <th>Attendance %</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        Object.keys(dailyStats).sort().reverse().forEach(date => {
            const data = dailyStats[date];
            const percent = data.total > 0 ? ((data.present / data.total) * 100).toFixed(1) : 0;
            html += `
                <tr>
                    <td>${date}</td>
                    <td>${data.total}</td>
                    <td>${data.present}</td>
                    <td>${percent}%</td>
                </tr>
            `;
        });
        
        html += `</tbody></table>`;
        return html;
    }
    
    function generateStudentReport(className) {
        let filtered = students;
        if (className !== 'all') {
            filtered = filtered.filter(s => s.class === className);
        }
        
        let html = `
            <div class="report-header">
                <h3>üë• Student Report</h3>
                <p>Class: ${className === 'all' ? 'All Classes' : className}</p>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Admission</th>
                        <th>Name</th>
                        <th>Class</th>
                        <th>Gender</th>
                        <th>Route</th>
                        <th>Parent Contact</th>
                        <th>Fee Balance</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        filtered.forEach(s => {
            const balance = calculateStudentBalance(s.admission);
            html += `
                <tr>
                    <td>${s.admission}</td>
                    <td>${s.name}</td>
                    <td>${s.class}</td>
                    <td>${s.gender}</td>
                    <td>${s.route}</td>
                    <td>${s.parentPhone || '-'}</td>
                    <td>KSh ${balance.toLocaleString()}</td>
                </tr>
            `;
        });
        
        html += `</tbody></table>`;
        return html;
    }
    
    function generateTeacherReport() {
        let html = `
            <div class="report-header">
                <h3>üë®‚Äçüè´ Teacher Report</h3>
                <p>All Teachers</p>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>TSC No.</th>
                        <th>Name</th>
                        <th>Gender</th>
                        <th>Subject</th>
                        <th>Phone</th>
                        <th>Email</th>
                        <th>Qualification</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        teachers.forEach(t => {
            html += `
                <tr>
                    <td>${t.tsc}</td>
                    <td>${t.name}</td>
                    <td>${t.gender || '-'}</td>
                    <td>${t.subject || '-'}</td>
                    <td>${t.phone || '-'}</td>
                    <td>${t.email || '-'}</td>
                    <td>${t.qualification || '-'}</td>
                </tr>
            `;
        });
        
        html += `</tbody></table>`;
        return html;
    }
    
    function generateExamReport(startDate, endDate, className) {
        let filtered = examResults;
        if (className !== 'all') {
            filtered = filtered.filter(r => r.class === className);
        }
        
        const examGroups = {};
        filtered.forEach(r => {
            const exam = exams.find(e => e.id === r.examId);
            if (exam) {
                const key = `${exam.name} (Term ${exam.term} ${exam.year})`;
                if (!examGroups[key]) {
                    examGroups[key] = { total: 0, count: 0, students: [] };
                }
                examGroups[key].total += r.score;
                examGroups[key].count++;
                examGroups[key].students.push(r);
            }
        });
        
        let html = `
            <div class="report-header">
                <h3>üìù Exam Report</h3>
                <p>Class: ${className === 'all' ? 'All Classes' : className}</p>
            </div>
        `;
        
        Object.keys(examGroups).forEach(examName => {
            const data = examGroups[examName];
            const mean = (data.total / data.count).toFixed(1);
            
            html += `
                <h4>${examName}</h4>
                <p>Mean Score: ${mean}% | Students: ${data.count}</p>
                <table>
                    <thead>
                        <tr>
                            <th>Admission</th>
                            <th>Student</th>
                            <th>Class</th>
                            <th>Subject</th>
                            <th>Score</th>
                            <th>Grade</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            data.students.sort((a, b) => b.score - a.score).forEach(r => {
                const student = students.find(s => s.admission === r.admission);
                html += `
                    <tr>
                        <td>${r.admission}</td>
                        <td>${student?.name || 'N/A'}</td>
                        <td>${r.class}</td>
                        <td>${r.subject}</td>
                        <td>${r.score}%</td>
                        <td>${r.grade}</td>
                    </tr>
                `;
            });
            
            html += `</tbody></table><br>`;
        });
        
        return html;
    }
    
    function generateFeeReport(className) {
        let filtered = fees;
        if (className !== 'all') {
            filtered = filtered.filter(f => f.class === className);
        }
        
        let html = `
            <div class="report-header">
                <h3>üí∞ Fee Report</h3>
                <p>Class: ${className === 'all' ? 'All Classes' : className} | Term: ${settings.currentTerm}</p>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Receipt</th>
                        <th>Admission</th>
                        <th>Student</th>
                        <th>Class</th>
                        <th>Amount</th>
                        <th>Mode</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        filtered.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(f => {
            const student = students.find(s => s.admission === f.admission);
            html += `
                <tr>
                    <td>${new Date(f.date).toLocaleDateString()}</td>
                    <td>${f.receipt}</td>
                    <td>${f.admission}</td>
                    <td>${student?.name || 'N/A'}</td>
                    <td>${f.class}</td>
                    <td>KSh ${f.amount.toLocaleString()}</td>
                    <td>${f.mode}</td>
                </tr>
            `;
        });
        
        html += `</tbody></table>`;
        return html;
    }
    
    function generateTripReport(startDate, endDate) {
        let filtered = trips;
        if (startDate) {
            filtered = filtered.filter(t => t.date >= startDate);
        }
        if (endDate) {
            filtered = filtered.filter(t => t.date <= endDate);
        }
        
        let html = `
            <div class="report-header">
                <h3>üöå Trip Report</h3>
                <p>Period: ${startDate || 'All'} to ${endDate || 'All'}</p>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Destination</th>
                        <th>Date</th>
                        <th>Teacher</th>
                        <th>Classes</th>
                        <th>Students</th>
                        <th>Cost/Student</th>
                        <th>Total Cost</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        filtered.sort((a, b) => new Date(a.date) - new Date(b.date)).forEach(t => {
            const payments = tripPayments.filter(p => p.tripId === t.id);
            const totalCollected = payments.reduce((sum, p) => sum + p.amount, 0);
            html += `
                <tr>
                    <td>${t.destination}</td>
                    <td>${new Date(t.date).toLocaleDateString()}</td>
                    <td>${t.teacherName || 'N/A'}</td>
                    <td>${t.classes}</td>
                    <td>${payments.length} / ${t.students || 0}</td>
                    <td>KSh ${t.cost.toLocaleString()}</td>
                    <td>KSh ${totalCollected.toLocaleString()}</td>
                </tr>
            `;
        });
        
        html += `</tbody></table>`;
        return html;
    }
    
    // ========== PRINT & DOWNLOAD FUNCTIONS ==========
    function printSection(sectionId) {
        const printContents = document.getElementById(sectionId).innerHTML;
        const originalContents = document.body.innerHTML;
        
        document.body.innerHTML = `
            <div style="padding: 20px;">
                <h1 style="text-align: center;">${settings.schoolName}</h1>
                <p style="text-align: center; margin-bottom: 30px;">Generated: ${new Date().toLocaleString()}</p>
                ${printContents}
            </div>
        `;
        
        window.print();
        document.body.innerHTML = originalContents;
        location.reload();
    }
    
    function downloadAsPDF(sectionId, filename) {
        const element = document.getElementById(sectionId);
        
        html2canvas(element).then(canvas => {
            const imgData = canvas.toDataURL('image/png');
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({
                orientation: 'portrait',
                unit: 'px',
                format: [canvas.width * 0.75, canvas.height * 0.75]
            });
            
            pdf.addImage(imgData, 'PNG', 0, 0, canvas.width * 0.75, canvas.height * 0.75);
            pdf.save(`${filename}_${new Date().toISOString().split('T')[0]}.pdf`);
        });
        
        showNotification('üì• PDF downloaded');
    }
    
    function downloadReportPDF() {
        const reportContent = document.getElementById('reportOutput').innerHTML;
        if (!reportContent || reportContent.includes('Select parameters')) {
            alert('Please generate a report first');
            return;
        }
        
        const element = document.createElement('div');
        element.innerHTML = `
            <h1 style="text-align: center;">${settings.schoolName}</h1>
            <p style="text-align: center;">Generated: ${new Date().toLocaleString()}</p>
            ${reportContent}
        `;
        
        html2canvas(element).then(canvas => {
            const imgData = canvas.toDataURL('image/png');
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({
                orientation: 'portrait',
                unit: 'px',
                format: [canvas.width * 0.75, canvas.height * 0.75]
            });
            
            pdf.addImage(imgData, 'PNG', 0, 0, canvas.width * 0.75, canvas.height * 0.75);
            pdf.save(`report_${new Date().toISOString().split('T')[0]}.pdf`);
        });
    }
    
    // ========== UTILITIES ==========
    function filterTable() {
        const input = document.getElementById('searchInput').value.toUpperCase();
        document.querySelectorAll('#rollTable tr').forEach(tr => {
            const className = tr.getAttribute('data-class') || '';
            tr.style.display = className.includes(input) ? '' : 'none';
        });
    }
    
    function switchTab(tab) {
        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('[id^="tab-"]').forEach(t => t.style.display = 'none');
        
        document.getElementById(`tab-${tab}`).style.display = 'block';
        event.currentTarget.classList.add('active');
        
        if (tab === 'analytics') {
            updateAnalytics();
        } else if (tab === 'students') {
            loadStudents();
        } else if (tab === 'teachers') {
            loadTeachers();
        } else if (tab === 'parents') {
            document.getElementById('parentSearchResults').innerHTML = '';
            document.getElementById('parentChildrenList').innerHTML = '';
        } else if (tab === 'classes') {
            loadClasses();
        } else if (tab === 'exams') {
            loadExams();
            loadExamResults();
        } else if (tab === 'fees') {
            loadFees();
            loadFeeStructureList();
        } else if (tab === 'trips') {
            loadTrips();
        } else if (tab === 'timetable') {
            generateTimetable();
        } else if (tab === 'settings') {
            applySettings();
        }
    }
    
    function toggleDarkMode() {
        const currentTheme = document.body.classList.contains('dark-mode') ? 'light' : 'dark';
        document.getElementById('themeSelect').value = currentTheme;
        changeTheme();
    }
    
    function showNotification(message) {
        const indicator = document.getElementById('offlineIndicator');
        indicator.style.display = 'block';
        indicator.style.background = '#27ae60';
        indicator.innerText = message;
        
        setTimeout(() => {
            indicator.style.display = 'none';
        }, 3000);
    }
    
    function exportToExcel() {
        try {
            const wb = XLSX.utils.book_new();
            const data = [];
            
            data.push(['Class', 'Boys', 'Girls', 'Total', 'Lunch', 'New', 'N.R.', 'Abs#', 'Absentee Names']);
            
            document.querySelectorAll('#rollTable tr').forEach(row => {
                const rowData = [
                    row.querySelector('.class-col')?.innerText || '',
                    row.querySelector('.c-b')?.innerText || '0',
                    row.querySelector('.c-g')?.innerText || '0',
                    row.querySelector('.c-t')?.innerText || '0',
                    row.querySelector('.c-l')?.innerText || '0',
                    row.querySelector('.c-n')?.innerText || '0',
                    row.querySelector('.c-nr')?.innerText || '0',
                    row.querySelector('.c-a')?.innerText || '0',
                    row.querySelector('.c-names')?.innerText || '-'
                ];
                data.push(rowData);
            });
            
            const ws = XLSX.utils.aoa_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws, "Attendance");
            
            XLSX.writeFile(wb, `attendance_${new Date().toISOString().split('T')[0]}.xlsx`);
            showNotification('üìä Excel file downloaded');
            
        } catch (error) {
            console.error('Export error:', error);
            alert('‚ùå Error exporting to Excel');
        }
    }
    
    // ========== SETTINGS ==========
    function applySettings() {
        document.getElementById('schoolName').value = settings.schoolName || 'Mountain View School';
        document.getElementById('schoolNameHeader').innerText = `üè´ ${settings.schoolName}`;
        document.getElementById('currentTerm').value = settings.currentTerm || '1';
        document.getElementById('academicYear').value = settings.academicYear || '2026';
        document.getElementById('themeSelect').value = settings.theme || 'light';
        document.getElementById('recoveryEmailSettings').value = recoveryEmail;
        
        if (settings.theme === 'dark') {
            document.body.classList.add('dark-mode');
        } else {
            document.body.classList.remove('dark-mode');
        }
    }
    
    function saveSettings() {
        settings = {
            schoolName: document.getElementById('schoolName').value,
            currentTerm: document.getElementById('currentTerm').value,
            academicYear: document.getElementById('academicYear').value,
            theme: document.getElementById('themeSelect').value
        };
        
        localStorage.setItem('settings', JSON.stringify(settings));
        applySettings();
        logActivity('Saved settings');
        showNotification('‚úÖ Settings saved!');
    }
    
    function resetSettings() {
        settings = {
            schoolName: 'Mountain View School',
            currentTerm: '1',
            academicYear: '2026',
            theme: 'light'
        };
        applySettings();
        showNotification('üîÑ Settings reset');
    }
    
    function changeTheme() {
        const theme = document.getElementById('themeSelect').value;
        settings.theme = theme;
        applySettings();
    }
    
    function updateSecuritySettings() {
        const newRecovery = document.getElementById('recoveryEmailSettings').value;
        const currentPass = document.getElementById('currentPassword').value;
        const newPass = document.getElementById('newPasswordSettings').value;
        const confirmPass = document.getElementById('confirmPassword').value;
        
        if (newRecovery) {
            recoveryEmail = newRecovery;
            localStorage.setItem('recoveryEmail', newRecovery);
        }
        
        if (currentPass && newPass && confirmPass) {
            if (currentPass === ADMIN_PASSWORD) {
                if (newPass === confirmPass) {
                    ADMIN_PASSWORD = newPass;
                    localStorage.setItem('adminPassword', newPass);
                    alert('‚úÖ Password updated successfully!');
                    logActivity('Password changed');
                } else {
                    alert('‚ùå New passwords do not match');
                    return;
                }
            } else {
                alert('‚ùå Current password is incorrect');
                return;
            }
        }
        
        showNotification('‚úÖ Security settings updated!');
    }
    
    function backupData() {
        const backup = {
            students,
            teachers,
            lessons,
            exams,
            examResults,
            fees,
            feeStructure,
            trips,
            tripPayments,
            attendanceHistory,
            classes,
            settings,
            adminPassword: ADMIN_PASSWORD,
            recoveryEmail: recoveryEmail,
            version: '4.0',
            timestamp: new Date().toISOString()
        };
        
        const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `school_backup_${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        logActivity('Created backup');
        showNotification('üíæ Backup created');
    }
    
    function restoreData() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        
        input.onchange = function(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const backup = JSON.parse(e.target.result);
                    
                    students = backup.students || [];
                    teachers = backup.teachers || [];
                    lessons = backup.lessons || [];
                    exams = backup.exams || [];
                    examResults = backup.examResults || [];
                    fees = backup.fees || [];
                    feeStructure = backup.feeStructure || {};
                    trips = backup.trips || [];
                    tripPayments = backup.tripPayments || [];
                    attendanceHistory = backup.attendanceHistory || [];
                    classes = backup.classes || [];
                    settings = backup.settings || settings;
                    ADMIN_PASSWORD = backup.adminPassword || ADMIN_PASSWORD;
                    recoveryEmail = backup.recoveryEmail || recoveryEmail;
                    
                    localStorage.setItem('students', JSON.stringify(students));
                    localStorage.setItem('teachers', JSON.stringify(teachers));
                    localStorage.setItem('lessons', JSON.stringify(lessons));
                    localStorage.setItem('exams', JSON.stringify(exams));
                    localStorage.setItem('examResults', JSON.stringify(examResults));
                    localStorage.setItem('fees', JSON.stringify(fees));
                    localStorage.setItem('feeStructure', JSON.stringify(feeStructure));
                    localStorage.setItem('trips', JSON.stringify(trips));
                    localStorage.setItem('tripPayments', JSON.stringify(tripPayments));
                    localStorage.setItem('attendanceHistory', JSON.stringify(attendanceHistory));
                    localStorage.setItem('classes', JSON.stringify(classes));
                    localStorage.setItem('settings', JSON.stringify(settings));
                    localStorage.setItem('adminPassword', ADMIN_PASSWORD);
                    localStorage.setItem('recoveryEmail', recoveryEmail);
                    
                    location.reload();
                    showNotification('‚úÖ Data restored successfully!');
                    
                } catch (err) {
                    alert('‚ùå Invalid backup file');
                }
            };
            
            reader.readAsText(file);
        };
        
        input.click();
    }
    
    // ========== OFFLINE SUPPORT ==========
    function checkOnlineStatus() {
        const indicator = document.getElementById('offlineIndicator');
        
        window.addEventListener('online', function() {
            indicator.style.display = 'block';
            indicator.className = 'offline-indicator online';
            indicator.innerText = 'üü¢ Online - Data synced';
            setTimeout(() => { indicator.style.display = 'none'; }, 3000);
        });
        
        window.addEventListener('offline', function() {
            indicator.style.display = 'block';
            indicator.className = 'offline-indicator';
            indicator.innerText = 'üî¥ Offline - Using cached data';
        });
        
        if (!navigator.onLine) {
            indicator.style.display = 'block';
            indicator.className = 'offline-indicator';
            indicator.innerText = 'üî¥ Offline - Using cached data';
        }
    }
</script>
</body>
</html>
